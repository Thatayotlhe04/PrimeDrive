<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeDrive Botswana — Buy, Rent & Sell Trusted Cars</title>
    <meta name="description" content="Botswana's trusted car marketplace. Buy, rent, and sell quality pre-owned vehicles in Gaborone. Fast deals, avoid scams, authentic.">
    <meta name="keywords" content="used cars Botswana, buy car Gaborone, rent car Botswana, sell car Botswana, PrimeDrive, pre-owned vehicles, car dealership Gaborone, car rental Botswana">
    <meta name="author" content="PrimeDrive Botswana">
    <meta property="og:title" content="PrimeDrive Botswana — Buy, Rent & Sell Trusted Cars">
    <meta property="og:description" content="Botswana's trusted car marketplace. Quality pre-owned vehicles in Gaborone.">
    <meta property="og:type" content="website">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://primedrivebotswana.com">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b5bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PrimeDrive">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="384x384" href="icons/icon-384x384.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b5bff">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

    <style>
        /* ========================================
           SPLASH SCREEN
           ======================================== */
        .splash {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #3b5bff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.45s ease, visibility 0.45s ease;
        }
        .splash.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .splash__logo {
            display: flex;
            align-items: center;
            gap: 2px;
            font-family: 'Outfit', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            letter-spacing: -0.03em;
            opacity: 0;
            transform: scale(0.8);
            animation: splashLogoIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.15s forwards;
        }
        .splash__dot {
            display: inline-block;
            width: 9px;
            height: 9px;
            background: #22c55e;
            border-radius: 50%;
            margin-left: 2px;
            margin-bottom: -2px;
            opacity: 0;
            transform: scale(0);
            animation: splashDotPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.65s forwards;
        }
        .splash__tagline {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 12px;
            letter-spacing: 0.5px;
            opacity: 0;
            transform: translateY(8px);
            animation: splashFadeUp 0.5s ease 0.55s forwards;
        }
        .splash__loader {
            margin-top: 40px;
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            opacity: 0;
            animation: splashFadeUp 0.3s ease 0.8s forwards, spin 0.7s linear 0.8s infinite;
        }
        .splash__car-icon {
            position: absolute;
            bottom: 48px;
            opacity: 0;
            animation: splashFadeUp 0.4s ease 0.7s forwards;
        }
        .splash__car-icon svg {
            width: 28px;
            height: 28px;
            fill: rgba(255, 255, 255, 0.25);
        }

        @keyframes splashLogoIn {
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes splashDotPop {
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes splashFadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           DESIGN SYSTEM — CSS VARIABLES
           ======================================== */
        :root {
            /* Color Palette — Light Mode (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f7f8fa;
            --bg-tertiary: #f0f1f4;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --bg-input: #f7f8fa;
            --bg-overlay: rgba(0, 0, 0, 0.5);

            --text-primary: #0f1117;
            --text-secondary: #5a5d6b;
            --text-tertiary: #8b8d97;
            --text-inverse: #ffffff;

            --border-default: #e4e5ea;
            --border-light: #edeef2;
            --border-focus: #3b5bff;

            --accent: #3b5bff;
            --accent-hover: #2d49db;
            --accent-light: #eef1ff;
            --accent-subtle: rgba(59, 91, 255, 0.08);

            --success: #22c55e;
            --success-bg: #f0fdf4;
            --whatsapp: #25d366;
            --whatsapp-hover: #20bd5a;

            --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
            --shadow-card: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04);
            --shadow-card-hover: 0 4px 20px rgba(0,0,0,0.10);

            --radius-xs: 6px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;

            --font-display: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;

            --transition-fast: 0.15s ease;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);

            --nav-height: 72px;
            --container-max: 1280px;
            --container-narrow: 720px;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #0f1117;
            --bg-secondary: #161821;
            --bg-tertiary: #1c1e2a;
            --bg-card: #1a1c28;
            --bg-elevated: #1e2030;
            --bg-input: #1a1c28;
            --bg-overlay: rgba(0, 0, 0, 0.7);

            --text-primary: #f0f1f4;
            --text-secondary: #9a9caa;
            --text-tertiary: #6b6d7b;
            --text-inverse: #0f1117;

            --border-default: #2a2c3a;
            --border-light: #222436;
            --border-focus: #5b7bff;

            --accent: #5b7bff;
            --accent-hover: #7b95ff;
            --accent-light: rgba(91, 123, 255, 0.12);
            --accent-subtle: rgba(91, 123, 255, 0.06);

            --shadow-xs: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.25);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.35);
            --shadow-card: 0 1px 3px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.15);
            --shadow-card-hover: 0 4px 24px rgba(0,0,0,0.35);
        }

        /* ========================================
           RESET & BASE
           ======================================== */
        *, *::before, *::after {
            margin: 0; padding: 0; box-sizing: border-box;
        }
        html {
            scroll-behavior: smooth;
            scroll-padding-top: calc(var(--nav-height) + 20px);
        }
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            transition: background var(--transition), color var(--transition);
        }
        a { color: inherit; text-decoration: none; }
        img { max-width: 100%; display: block; }
        button, input, select, textarea {
            font-family: var(--font-body);
            border: none;
            outline: none;
            background: none;
            color: inherit;
        }
        ::selection {
            background: var(--accent);
            color: white;
        }

        /* ========================================
           LAYOUT
           ======================================== */
        .container {
            max-width: var(--container-max);
            margin: 0 auto;
            padding: 0 24px;
        }
        .container--narrow {
            max-width: var(--container-narrow);
        }

        /* ========================================
           TYPOGRAPHY
           ======================================== */
        .label {
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .label i { font-size: 0.85rem; }
        .heading-xl {
            font-family: var(--font-display);
            font-size: clamp(2.5rem, 5.5vw, 4rem);
            font-weight: 800;
            line-height: 1.08;
            letter-spacing: -0.03em;
        }
        .heading-lg {
            font-family: var(--font-display);
            font-size: clamp(1.75rem, 3.5vw, 2.5rem);
            font-weight: 700;
            line-height: 1.15;
            letter-spacing: -0.02em;
        }
        .heading-md {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        .body-lg {
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        .body-sm {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .body-xs {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-body);
            font-weight: 600;
            font-size: 0.9rem;
            padding: 12px 28px;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
            line-height: 1.4;
        }
        .btn i { font-size: 1rem; }
        .btn--primary {
            background: var(--accent);
            color: white;
        }
        .btn--primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59,91,255,0.25);
        }
        .btn--secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }
        .btn--secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-tertiary);
            transform: translateY(-1px);
        }
        .btn--outline {
            background: transparent;
            color: var(--text-primary);
            border: 1.5px solid var(--border-default);
        }
        .btn--outline:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }
        .btn--whatsapp {
            background: var(--whatsapp);
            color: white;
        }
        .btn--whatsapp:hover {
            background: var(--whatsapp-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(37,211,102,0.3);
        }
        .btn--google {
            background: #fff;
            color: #3c4043;
            border: 1px solid #dadce0;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn--google:hover {
            background: #f7f8f8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .btn--ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 8px 16px;
        }
        .btn--ghost:hover { color: var(--accent); }
        .btn--sm { padding: 9px 20px; font-size: 0.82rem; }
        .btn--lg { padding: 16px 36px; font-size: 1rem; }
        .btn--full { width: 100%; }
        .btn--icon-only {
            width: 44px; height: 44px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        /* ========================================
           NAVIGATION
           ======================================== */
        .nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            height: var(--nav-height);
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.82);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid transparent;
            transition: all var(--transition);
        }
        [data-theme="dark"] .nav {
            background: rgba(15,17,23,0.82);
        }
        .nav.scrolled {
            border-bottom-color: var(--border-light);
            box-shadow: var(--shadow-xs);
        }
        .nav__inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .nav__logo {
            font-family: var(--font-display);
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
        }
        .nav__logo-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            background: var(--accent);
            border-radius: 50%;
            margin-left: 1px;
            margin-bottom: -2px;
        }
        .nav__links {
            display: flex;
            align-items: center;
            gap: 4px;
            list-style: none;
        }
        .nav__link {
            padding: 8px 16px;
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        .nav__link:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        .nav__link.active {
            color: var(--accent);
            background: var(--accent-subtle);
            font-weight: 600;
        }
        .nav__actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .nav__theme-toggle {
            width: 40px; height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            font-size: 1.1rem;
        }
        .nav__theme-toggle:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Hamburger */
        .nav__hamburger {
            display: none;
            width: 40px; height: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background var(--transition-fast);
        }
        .nav__hamburger:hover { background: var(--bg-secondary); }
        .nav__hamburger-icon {
            width: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .nav__hamburger-icon span {
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all var(--transition);
        }
        .nav__hamburger.active .nav__hamburger-icon span:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
        }
        .nav__hamburger.active .nav__hamburger-icon span:nth-child(2) { opacity: 0; }
        .nav__hamburger.active .nav__hamburger-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(4px, -4px);
        }

        /* Mobile Nav */
        .mobile-nav {
            position: fixed;
            top: var(--nav-height);
            left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            z-index: 999;
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 4px;
            transform: translateX(100%);
            transition: transform var(--transition-slow);
        }
        .mobile-nav.active { transform: translateX(0); }
        .mobile-nav__link {
            font-size: 1.05rem;
            font-weight: 500;
            padding: 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .mobile-nav__link:hover, .mobile-nav__link.active {
            background: var(--accent-subtle);
            color: var(--accent);
        }
        .mobile-nav__link i { font-size: 1.15rem; width: 24px; text-align: center; }
        .mobile-nav__divider {
            height: 1px;
            background: var(--border-light);
            margin: 12px 0;
        }

        /* ========================================
           PAGE SYSTEM
           ======================================== */
        .page { display: none; }
        .page.active { display: block; animation: pageIn 0.35s ease; }

        @keyframes pageIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spin { animation: spin 0.8s linear infinite; display: inline-block; }

        /* ========================================
           HERO
           ======================================== */
        .hero {
            padding: calc(var(--nav-height) + 60px) 0 80px;
            position: relative;
            overflow: hidden;
        }
        .hero__bg-pattern {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse 60% 50% at 65% 20%, var(--accent-subtle) 0%, transparent 70%),
                radial-gradient(ellipse 40% 40% at 20% 80%, rgba(59,91,255,0.03) 0%, transparent 70%);
            pointer-events: none;
        }
        .hero__grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 64px;
            align-items: center;
            position: relative;
        }
        .hero__content { max-width: 560px; }
        .hero__badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--success-bg);
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-size: 0.78rem;
            font-weight: 600;
            color: #16a34a;
            margin-bottom: 24px;
        }
        [data-theme="dark"] .hero__badge {
            background: rgba(34,197,94,0.1);
            color: #4ade80;
        }
        .hero__badge i { font-size: 0.7rem; }
        .hero__title { margin-bottom: 20px; }
        .hero__title-accent { color: var(--accent); }
        .hero__desc {
            font-size: 1.1rem;
            line-height: 1.75;
            color: var(--text-secondary);
            margin-bottom: 36px;
            max-width: 460px;
        }
        .hero__actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 56px;
        }
        .hero__stats {
            display: flex;
            gap: 40px;
        }
        .hero__stat-value {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }
        .hero__stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* Hero Featured Car */
        .hero__featured {
            position: relative;
        }
        .hero__car-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition);
        }
        .hero__car-image {
            width: 100%;
            height: 300px;
            background: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }
        .hero__car-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .hero__car-badge {
            position: absolute;
            top: 16px; left: 16px;
            background: var(--accent);
            color: white;
            padding: 5px 14px;
            border-radius: var(--radius-full);
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .hero__car-badge i { font-size: 0.7rem; }
        .hero__car-body { padding: 24px; }
        .hero__car-name {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .hero__car-meta {
            display: flex;
            gap: 16px;
            font-size: 0.82rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }
        .hero__car-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .hero__car-meta i { font-size: 0.85rem; }
        .hero__car-price {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 800;
        }
        .hero__car-price-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        /* Floating decorative badge */
        .hero__float-card {
            position: absolute;
            bottom: -20px;
            right: -16px;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: floatCard 4s ease-in-out infinite;
        }
        @keyframes floatCard {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .hero__float-icon {
            width: 40px; height: 40px;
            background: var(--success-bg);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
            font-size: 1rem;
        }
        [data-theme="dark"] .hero__float-icon {
            background: rgba(34,197,94,0.1);
        }
        .hero__float-text {
            font-size: 0.82rem;
            font-weight: 600;
        }
        .hero__float-sub {
            font-size: 0.72rem;
            color: var(--text-tertiary);
        }

        /* Brands */
        .brands-strip {
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
            padding: 24px 0;
            background: var(--bg-secondary);
        }
        .brands-strip__inner {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 48px;
            flex-wrap: wrap;
        }
        .brands-strip__item {
            font-family: var(--font-display);
            font-size: 0.82rem;
            font-weight: 700;
            letter-spacing: 2.5px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            opacity: 0.5;
            transition: opacity var(--transition);
        }
        .brands-strip__item:hover { opacity: 0.8; }

        /* Featured Listings */
        .featured-listings {
            padding: 64px 0;
        }
        .featured-listings__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 32px;
            gap: 16px;
        }
        .featured-listings__header .label { margin-bottom: 8px; }
        .featured-listings__empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-tertiary);
            grid-column: 1 / -1;
        }
        .featured-listings__empty i { font-size: 2.5rem; margin-bottom: 12px; display: block; }

        /* Seller info on cards */
        .car-card__seller {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-top: 1px solid var(--border-default);
            font-size: 0.78rem;
            color: var(--text-secondary);
        }
        .car-card__seller-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        .car-card__seller-name {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .car-card__seller-role {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }
        @media (max-width: 640px) {
            .featured-listings { padding: 40px 0; }
            .featured-listings__header { flex-direction: column; align-items: flex-start; }
        }

        /* ============================= */
        /* MESSAGING                     */
        /* ============================= */
        .msg-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 0;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-height: 520px;
            background: var(--bg-primary);
        }
        .msg-list {
            border-right: 1px solid var(--border-default);
            overflow-y: auto;
            max-height: 600px;
        }
        .msg-conv {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-default);
            cursor: pointer;
            transition: background 0.15s;
        }
        .msg-conv:hover, .msg-conv--active { background: var(--bg-secondary); }
        .msg-conv__avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.85rem; flex-shrink: 0;
        }
        .msg-conv__info { flex: 1; min-width: 0; }
        .msg-conv__name {
            font-weight: 600; font-size: 0.88rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .msg-conv__preview {
            font-size: 0.78rem; color: var(--text-tertiary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-top: 2px;
        }
        .msg-conv__meta {
            display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0;
        }
        .msg-conv__time { font-size: 0.7rem; color: var(--text-tertiary); }
        .msg-conv__unread {
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--accent); color: #fff;
            font-size: 0.65rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
        }
        .msg-chat {
            display: flex; flex-direction: column; min-height: 0;
        }
        .msg-chat__empty {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 40px;
        }
        .msg-chat__header {
            padding: 14px 20px; border-bottom: 1px solid var(--border-default);
            display: flex; align-items: center; gap: 12px;
        }
        .msg-chat__header-name { font-weight: 700; font-size: 0.95rem; }
        .msg-chat__header-listing { font-size: 0.78rem; color: var(--text-tertiary); }
        .msg-chat__body {
            flex: 1; overflow-y: auto; padding: 20px; max-height: 420px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .msg-bubble {
            max-width: 75%; padding: 10px 14px;
            border-radius: 16px; font-size: 0.88rem; line-height: 1.45;
            word-wrap: break-word;
        }
        .msg-bubble--sent {
            align-self: flex-end;
            background: var(--accent); color: #fff;
            border-bottom-right-radius: 4px;
        }
        .msg-bubble--received {
            align-self: flex-start;
            background: var(--bg-secondary); color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .msg-bubble__time {
            font-size: 0.65rem; margin-top: 4px;
            opacity: 0.7;
        }
        .msg-chat__input {
            padding: 12px 16px; border-top: 1px solid var(--border-default);
            display: flex; gap: 8px;
        }
        .msg-chat__input input {
            flex: 1; border: 1px solid var(--border-default);
            border-radius: var(--radius-md); padding: 10px 14px;
            font-size: 0.88rem; background: var(--bg-primary);
            color: var(--text-primary); outline: none;
        }
        .msg-chat__input input:focus { border-color: var(--accent); }
        .msg-chat__input button {
            background: var(--accent); color: #fff; border: none;
            border-radius: var(--radius-md); padding: 10px 16px;
            font-weight: 600; cursor: pointer; font-size: 0.88rem;
        }
        .msg-chat__input button:hover { opacity: 0.9; }
        .msg-badge {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 18px; height: 18px; border-radius: 9px;
            background: #ef4444; color: #fff; font-size: 0.65rem;
            font-weight: 700; padding: 0 5px; margin-left: 4px;
        }
        @media (max-width: 768px) {
            .msg-layout { grid-template-columns: 1fr; min-height: auto; }
            .msg-list { border-right: none; border-bottom: 1px solid var(--border-default); max-height: 280px; }
            .msg-chat__body { max-height: 300px; }
        }

        /* ============================= */
        /* CHECKOUT                      */
        /* ============================= */
        .checkout-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .checkout-card__car {
            display: flex; gap: 16px; padding: 20px;
            border-bottom: 1px solid var(--border-default);
        }
        .checkout-card__car img {
            width: 120px; height: 80px; object-fit: cover;
            border-radius: var(--radius-sm);
        }
        .checkout-card__car-info h3 {
            font-size: 1rem; font-weight: 700; margin-bottom: 4px;
        }
        .checkout-card__breakdown {
            padding: 20px;
        }
        .checkout-card__row {
            display: flex; justify-content: space-between;
            padding: 8px 0; font-size: 0.92rem;
        }
        .checkout-card__row--total {
            border-top: 2px solid var(--border-default);
            margin-top: 8px; padding-top: 12px;
            font-weight: 700; font-size: 1.05rem;
        }
        .checkout-card__methods {
            padding: 0 20px 20px;
        }
        .checkout-card__method {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; border: 2px solid var(--border-default);
            border-radius: var(--radius-md); cursor: pointer;
            margin-bottom: 8px; transition: border-color 0.15s;
        }
        .checkout-card__method:hover { border-color: var(--accent); }
        .checkout-card__method--selected { border-color: var(--accent); background: var(--accent-light); }
        .checkout-card__method input { display: none; }
        .checkout-card__method i { font-size: 1.3rem; color: var(--accent); }
        .checkout-card__actions {
            padding: 0 20px 24px;
        }
        .checkout-card__ref {
            background: var(--bg-secondary); border-radius: var(--radius-md);
            padding: 14px 16px; margin-bottom: 16px; text-align: center;
        }
        .checkout-card__ref-label { font-size: 0.78rem; color: var(--text-tertiary); }
        .checkout-card__ref-code { font-size: 1.1rem; font-weight: 700; font-family: var(--font-mono, monospace); margin-top: 4px; }
        .checkout-card__instructions {
            background: var(--bg-secondary); border-radius: var(--radius-md);
            padding: 16px; margin-bottom: 16px; font-size: 0.85rem;
            line-height: 1.6;
        }
        .btn--accent {
            background: #f59e0b; color: #000; font-weight: 700;
        }
        .btn--accent:hover { background: #d97706; }

        /* ============================= */
        /* TOAST NOTIFICATIONS           */
        /* ============================= */
        .toast-container {
            position: fixed; top: 80px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 8px;
            max-width: 380px; width: 100%;
            pointer-events: none;
        }
        .toast {
            background: var(--bg-primary); border: 1px solid var(--border-default);
            border-radius: var(--radius-md); padding: 14px 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            display: flex; align-items: flex-start; gap: 10px;
            pointer-events: auto; cursor: pointer;
            animation: toastIn 0.3s ease-out;
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast--exit { opacity: 0; transform: translateX(40px); }
        .toast__icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
        .toast--success .toast__icon { color: #16a34a; }
        .toast--info .toast__icon { color: #3b82f6; }
        .toast--warning .toast__icon { color: #f59e0b; }
        .toast--error .toast__icon { color: #ef4444; }
        .toast__body { flex: 1; }
        .toast__title { font-weight: 700; font-size: 0.85rem; margin-bottom: 2px; }
        .toast__msg { font-size: 0.8rem; color: var(--text-tertiary); line-height: 1.4; }
        .toast__close {
            font-size: 0.9rem; color: var(--text-tertiary); cursor: pointer;
            padding: 0 4px; flex-shrink: 0;
        }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 480px) {
            .toast-container { right: 8px; left: 8px; max-width: none; top: 70px; }
        }

        /* ============================= */
        /* RECEIPT MODAL                 */
        /* ============================= */
        .receipt-overlay {
            position: fixed; inset: 0; z-index: 9000;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .receipt-overlay.active { display: flex; }
        .receipt-card {
            background: #fff; color: #111; border-radius: 12px;
            max-width: 480px; width: 100%; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .receipt-card__header {
            padding: 24px 24px 16px; border-bottom: 1px solid #eee;
            text-align: center;
        }
        .receipt-card__logo { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
        .receipt-card__logo span { display: inline-block; width: 6px; height: 6px; background: #22c55e; border-radius: 50%; margin-left: 1px; }
        .receipt-card__subtitle { font-size: 0.78rem; color: #888; margin-top: 4px; }
        .receipt-card__body { padding: 20px 24px; }
        .receipt-card__row {
            display: flex; justify-content: space-between; padding: 6px 0;
            font-size: 0.88rem;
        }
        .receipt-card__row--label { color: #666; }
        .receipt-card__row--total {
            border-top: 2px solid #222; margin-top: 8px; padding-top: 10px;
            font-weight: 700; font-size: 1rem;
        }
        .receipt-card__divider { border: none; border-top: 1px dashed #ddd; margin: 16px 0; }
        .receipt-card__section-title { font-weight: 700; font-size: 0.82rem; color: #333; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .receipt-card__footer {
            padding: 16px 24px; border-top: 1px solid #eee;
            text-align: center; font-size: 0.75rem; color: #999;
        }
        .receipt-card__actions {
            padding: 0 24px 20px; display: flex; gap: 8px;
        }
        .receipt-card__actions button {
            flex: 1; padding: 10px; border-radius: 8px; font-weight: 600;
            font-size: 0.85rem; cursor: pointer; border: none;
        }
        .receipt-card__btn-print { background: #111; color: #fff; }
        .receipt-card__btn-close { background: #f3f4f6; color: #333; }
        @media print {
            body > *:not(.receipt-overlay) { display: none !important; }
            .receipt-overlay { position: static; background: none; display: flex !important; }
            .receipt-card { box-shadow: none; max-height: none; }
            .receipt-card__actions { display: none; }
        }

        /* ============================= */
        /* DISPUTE FLOW                  */
        /* ============================= */
        .dispute-form {
            background: var(--bg-secondary); border-radius: var(--radius-md);
            padding: 20px; margin-top: 16px;
        }
        .dispute-form__label { font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; }
        .dispute-form textarea {
            width: 100%; min-height: 80px; border: 1px solid var(--border-default);
            border-radius: var(--radius-sm); padding: 10px; font-size: 0.88rem;
            background: var(--bg-primary); color: var(--text-primary);
            resize: vertical; font-family: inherit;
        }
        .dispute-form textarea:focus { border-color: var(--accent); outline: none; }
        .dispute-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 10px; font-size: 0.72rem;
            font-weight: 600;
        }
        .dispute-badge--open { background: #fef2f2; color: #dc2626; }
        .dispute-badge--reviewing { background: #fffbeb; color: #d97706; }
        .dispute-badge--resolved { background: #f0fdf4; color: #16a34a; }

        /* ========================================
           FEATURES GRID (Home)
           ======================================== */
        .features { padding: 100px 0; }
        .features__header {
            text-align: center;
            max-width: 540px;
            margin: 0 auto 56px;
        }
        .features__header .label { justify-content: center; margin-bottom: 12px; }
        .features__header .heading-lg { margin-bottom: 16px; }
        .features__grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .feature-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 36px 28px;
            transition: all var(--transition);
        }
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
            border-color: var(--accent);
        }
        .feature-card__icon {
            width: 52px; height: 52px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--accent);
            margin-bottom: 20px;
        }
        .feature-card__title {
            font-family: var(--font-display);
            font-size: 1.08rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .feature-card__desc {
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.65;
        }

        /* ========================================
           CAR LISTINGS (Buy / Rent)
           ======================================== */
        .listings { padding: calc(var(--nav-height) + 40px) 0 80px; }
        .listings__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 32px;
        }
        .listings__header-text .label { margin-bottom: 8px; }
        .listings__count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Filters */
        .filters {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            margin-bottom: 28px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-group label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }
        .filter-select, .filter-input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.88rem;
            font-family: var(--font-body);
            transition: border-color var(--transition-fast);
            cursor: pointer;
            appearance: auto;
        }
        .filter-select:focus, .filter-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }
        .filter-select option { background: var(--bg-card); }
        .filter-reset {
            align-self: flex-end;
            margin-bottom: 0;
        }

        /* Car Grid */
        .car-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
            gap: 20px;
        }
        .car-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition);
            position: relative;
        }
        .car-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }
        .car-card__image {
            width: 100%;
            height: 210px;
            background: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }
        .car-card__image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }
        .car-card:hover .car-card__image img {
            transform: scale(1.04);
        }
        .car-card__badge {
            position: absolute;
            top: 12px; left: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 5px 12px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .car-card__badge i { font-size: 0.7rem; }
        .car-card__badge--accent {
            background: var(--accent);
            color: white;
        }
        .car-card__type-badge {
            position: absolute;
            top: 12px; right: 12px;
            padding: 5px 12px;
            border-radius: var(--radius-full);
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .car-card__type-badge--rent {
            background: rgba(99, 102, 241, 0.9);
            color: white;
        }
        .car-card__type-badge--sale {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }
        .car-card__body { padding: 20px; }
        .car-card__name {
            font-family: var(--font-display);
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        .car-card__specs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }
        .car-card__spec {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }
        .car-card__spec i { font-size: 0.85rem; color: var(--text-tertiary); }
        .car-card__divider {
            height: 1px;
            background: var(--border-light);
            margin-bottom: 16px;
        }
        .car-card__footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .car-card__price {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 800;
        }
        .car-card__price-sub {
            font-size: 0.72rem;
            color: var(--text-tertiary);
            font-weight: 400;
            font-family: var(--font-body);
        }
        .car-card__location {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }
        .car-card__location i { font-size: 0.8rem; }
        .car-card__cta { padding: 0 20px 20px; }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 20px;
        }
        .no-results__icon {
            font-size: 2.5rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }
        .no-results__title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        /* ========================================
           FORMS (Sell / Sourcing)
           ======================================== */
        .form-page { padding: calc(var(--nav-height) + 40px) 0 80px; }
        .form-page__header {
            max-width: 560px;
            margin-bottom: 40px;
        }
        .form-page__header .label { margin-bottom: 8px; }
        .form-page__header .heading-lg { margin-bottom: 12px; }

        .form-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 36px;
            box-shadow: var(--shadow-card);
            max-width: 720px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group--full { grid-column: 1 / -1; }
        .form-group__label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .form-control {
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.92rem;
            font-family: var(--font-body);
            transition: all var(--transition-fast);
        }
        .form-control:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }
        .form-control::placeholder { color: var(--text-tertiary); }
        textarea.form-control { resize: vertical; min-height: 100px; }
        select.form-control option { background: var(--bg-card); }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-md);
            padding: 40px 24px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
        }
        .upload-area:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }
        .upload-area input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .upload-area__icon {
            font-size: 2rem;
            color: var(--text-tertiary);
            margin-bottom: 10px;
        }
        .upload-area__text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .upload-area__hint {
            font-size: 0.78rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        .upload-previews {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .upload-preview {
            width: 80px; height: 80px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            overflow: hidden;
            position: relative;
        }
        .upload-preview img { width: 100%; height: 100%; object-fit: cover; }
        .upload-preview__remove {
            position: absolute;
            top: 4px; right: 4px;
            width: 20px; height: 20px;
            background: rgba(239,68,68,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: #fff;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }
        .upload-preview__remove:hover { transform: scale(1.15); }

        /* ========================================
           SOURCING FEATURES
           ======================================== */
        .sourcing-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 48px 0;
        }
        .sourcing-step {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            text-align: center;
            transition: all var(--transition);
            position: relative;
        }
        .sourcing-step:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }
        .sourcing-step__number {
            position: absolute;
            top: 16px; right: 16px;
            font-family: var(--font-display);
            font-size: 0.72rem;
            font-weight: 800;
            color: var(--text-tertiary);
            opacity: 0.4;
        }
        .sourcing-step__icon {
            width: 56px; height: 56px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: var(--accent);
            margin: 0 auto 18px;
        }
        .sourcing-step__title {
            font-family: var(--font-display);
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .sourcing-step__desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ========================================
           ABOUT
           ======================================== */
        .about { padding: calc(var(--nav-height) + 40px) 0 80px; }
        .about__grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 64px;
            align-items: start;
        }
        .about__content .label { margin-bottom: 8px; }
        .about__content .heading-lg { margin-bottom: 16px; }
        .about__text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 12px;
        }
        .about__values {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 36px;
        }
        .about__value {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .about__value-icon {
            width: 48px; height: 48px;
            min-width: 48px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.15rem;
            color: var(--accent);
        }
        .about__value-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .about__value-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .about__visual {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }
        .about__visual-image {
            width: 100%;
            height: 280px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .about__visual-image img { width: 100%; height: 100%; object-fit: cover; }
        .about__visual-body {
            padding: 28px;
        }
        .about__visual-stat {
            display: flex;
            gap: 32px;
        }
        .about__visual-stat-item { }
        .about__visual-stat-value {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 800;
        }
        .about__visual-stat-label {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }

        /* ========================================
           CONTACT
           ======================================== */
        .contact { padding: calc(var(--nav-height) + 40px) 0 80px; }
        .contact__header {
            text-align: center;
            max-width: 540px;
            margin: 0 auto 48px;
        }
        .contact__header .label { justify-content: center; margin-bottom: 8px; }
        .contact__header .heading-lg { margin-bottom: 12px; }
        .contact__grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .contact__card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 32px;
        }
        .contact__item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .contact__item:last-of-type { border-bottom: none; }
        .contact__item-icon {
            width: 48px; height: 48px;
            min-width: 48px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--accent);
        }
        .contact__item-label {
            font-size: 0.82rem;
            font-weight: 600;
        }
        .contact__item-value {
            font-size: 0.88rem;
            color: var(--text-secondary);
        }
        .contact__item-value a {
            color: var(--accent);
            transition: color var(--transition-fast);
        }
        .contact__item-value a:hover { color: var(--accent-hover); }
        .contact__socials {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .contact__social-link {
            width: 44px; height: 44px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.05rem;
            color: var(--text-secondary);
            transition: all var(--transition);
            cursor: pointer;
        }
        .contact__social-link:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-subtle);
            transform: translateY(-2px);
        }
        .contact__map {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            overflow: hidden;
            min-height: 360px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }
        .contact__map-pin {
            width: 64px; height: 64px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: var(--accent);
        }
        .contact__map-text {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 700;
        }

        /* ========================================
           FOOTER
           ======================================== */
        .footer {
            border-top: 1px solid var(--border-light);
            padding: 48px 0 32px;
            margin-top: 40px;
            background: var(--bg-secondary);
        }
        .footer__inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .footer__logo {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .footer__links {
            display: flex;
            gap: 24px;
            list-style: none;
        }
        .footer__link {
            font-size: 0.82rem;
            color: var(--text-tertiary);
            transition: color var(--transition-fast);
            cursor: pointer;
        }
        .footer__link:hover { color: var(--accent); }
        .footer__copy {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }

        /* ========================================
           PWA INSTALL BANNER
           ======================================== */
        .pwa-install-banner {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 1001;
            background: var(--bg-card);
            border-top: 1px solid var(--border-default);
            padding: 16px 20px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 16px;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.12);
            animation: slideUpBanner 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pwa-install-banner.show { display: flex; }
        @keyframes slideUpBanner {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .pwa-install-banner__icon {
            width: 48px; height: 48px; min-width: 48px;
            border-radius: var(--radius-md);
            background: var(--accent);
            display: flex; align-items: center; justify-content: center;
            color: white; font-family: var(--font-display);
            font-weight: 800; font-size: 1.25rem;
        }
        .pwa-install-banner__text {
            flex: 1;
        }
        .pwa-install-banner__title {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 0.92rem;
            margin-bottom: 2px;
        }
        .pwa-install-banner__desc {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }
        .pwa-install-banner__actions {
            display: flex; gap: 8px; align-items: center;
        }
        .pwa-install-banner__close {
            width: 32px; height: 32px;
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--text-tertiary);
            cursor: pointer; transition: all var(--transition-fast);
        }
        .pwa-install-banner__close:hover {
            background: var(--bg-secondary); color: var(--text-primary);
        }

        /* Shift support float up when install banner is showing */
        .pwa-install-banner.show ~ .wa-float { bottom: 100px; }

        @media (max-width: 480px) {
            .pwa-install-banner { flex-wrap: wrap; }
            .pwa-install-banner__actions { width: 100%; }
            .pwa-install-banner__actions .btn { flex: 1; }
        }

        /* ========================================
           WHATSAPP FLOAT
           ======================================== */
        .wa-float {
            position: fixed;
            bottom: 28px; right: 28px;
            z-index: 998;
        }
        .wa-float__btn {
            width: 56px; height: 56px;
            background: var(--whatsapp);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 4px 16px rgba(37,211,102,0.35);
        }
        .wa-float__btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(37,211,102,0.45);
        }

        /* ========================================
           LOGIN OVERLAY
           ======================================== */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: var(--bg-overlay);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .login-overlay.active { display: flex; }
        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            position: relative;
            animation: loginSlide 0.35s ease;
        }
        @keyframes loginSlide {
            from { opacity: 0; transform: translateY(24px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .login-card__close {
            position: absolute;
            top: 16px; right: 16px;
            width: 36px; height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .login-card__close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .login-card__logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
        }
        .login-card__subtitle {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .login-card .form-group { margin-bottom: 16px; }
        .login-card__error {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.82rem;
            margin-bottom: 16px;
            display: none;
        }
        .login-card__error.show { display: block; }
        .login-card__divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 24px 0;
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }
        .login-card__divider::before,
        .login-card__divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-default);
        }
        .login-card__alt {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 20px;
        }
        .login-card__alt a {
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
        }
        .login-card__alt a:hover { text-decoration: underline; }

        /* Password visibility toggle */
        .input-with-icon {
            position: relative;
        }
        .input-with-icon .form-control {
            padding-right: 44px;
        }
        .input-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
        }
        .input-toggle:hover { color: var(--text-secondary); }

        /* ========================================
           SUBSCRIPTION PAYWALL
           ======================================== */
        .paywall { padding: calc(var(--nav-height) + 48px) 0 80px; }
        .paywall__header {
            text-align: center;
            max-width: 600px;
            margin: 0 auto 36px;
        }
        .paywall__header .label { justify-content: center; margin-bottom: 12px; }
        .paywall__header .heading-lg { margin-bottom: 12px; }
        .paywall__header .body-lg { max-width: 520px; margin: 0 auto; }

        /* Plan type toggle */
        .paywall__toggle {
            display: inline-flex;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-full);
            padding: 4px;
            gap: 4px;
            margin-top: 24px;
        }
        .paywall__toggle-btn {
            padding: 10px 24px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .paywall__toggle-btn i { font-size: 1rem; }
        .paywall__toggle-btn.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Plan panels */
        .paywall__panel { display: none; }
        .paywall__panel.active { display: block; animation: pageIn 0.3s ease; }

        /* Grid */
        .paywall__grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            max-width: 1120px;
            margin: 0 auto;
        }
        .paywall__grid--dealer {
            grid-template-columns: repeat(3, 1fr);
            max-width: 900px;
        }

        /* Tier cards */
        .tier-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }
        .tier-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }
        .tier-card--popular {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent), var(--shadow-md);
        }
        .tier-card--popular::before {
            content: attr(data-badge);
            position: absolute;
            top: 0; left: 0; right: 0;
            background: var(--accent);
            color: white;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 6px;
        }
        .tier-card--popular .tier-card__inner { padding-top: 16px; }
        .tier-card__icon {
            width: 48px; height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 16px;
        }
        .tier-card__icon--free { background: var(--bg-secondary); color: var(--text-secondary); }
        .tier-card__icon--basic { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .tier-card__icon--standard { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .tier-card__icon--premium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .tier-card__icon--dealer-starter { background: rgba(20, 184, 166, 0.1); color: #14b8a6; }
        .tier-card__icon--dealer-pro { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
        .tier-card__icon--dealer-elite { background: rgba(234, 179, 8, 0.08); color: #d4a00a; }
        .tier-card__name {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .tier-card__desc {
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .tier-card__price {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin-bottom: 4px;
        }
        .tier-card__amount {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }
        .tier-card__period {
            font-size: 0.82rem;
            color: var(--text-tertiary);
        }
        .tier-card__billing {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 24px;
        }
        .tier-card__features {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 28px;
            flex: 1;
        }
        .tier-card__feature {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.84rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .tier-card__feature i {
            color: var(--success);
            font-size: 0.85rem;
            margin-top: 2px;
            flex-shrink: 0;
        }
        .tier-card__feature--disabled {
            color: var(--text-tertiary);
            opacity: 0.5;
        }
        .tier-card__feature--disabled i { color: var(--text-tertiary); }
        .tier-card__cta .btn { width: 100%; }
        .tier-card__current {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 12px 28px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
        }

        /* Commission section */
        .commission {
            max-width: 800px;
            margin: 64px auto 0;
            padding: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            position: relative;
            overflow: hidden;
        }
        .commission::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6, #f59e0b);
        }
        .commission__header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
        }
        .commission__icon {
            width: 44px; height: 44px;
            background: var(--accent-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.15rem;
            color: var(--accent);
        }
        .commission__title {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 700;
        }
        .commission__rates {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 20px;
        }
        .commission__rate {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }
        .commission__rate-value {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .commission__rate-label {
            font-size: 0.82rem;
            color: var(--text-secondary);
        }
        .commission__note {
            font-size: 0.84rem;
            color: var(--text-tertiary);
            line-height: 1.65;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent);
        }

        /* FAQ section */
        .pricing-faq {
            max-width: 800px;
            margin: 48px auto 0;
        }
        .pricing-faq__title {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
        }
        .faq-item {
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            overflow: hidden;
            background: var(--bg-card);
            transition: all var(--transition-fast);
        }
        .faq-item.open { border-color: var(--accent); }
        .faq-item__q {
            padding: 18px 20px;
            font-size: 0.92rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            transition: background var(--transition-fast);
        }
        .faq-item__q:hover { background: var(--bg-secondary); }
        .faq-item__q i {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            transition: transform var(--transition);
            flex-shrink: 0;
        }
        .faq-item.open .faq-item__q i { transform: rotate(180deg); color: var(--accent); }
        .faq-item__a {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .faq-item.open .faq-item__a {
            max-height: 300px;
            padding: 0 20px 18px;
        }
        .faq-item__a p {
            font-size: 0.86rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Payment method selector */
        .pay-methods {
            display: flex;
            gap: 8px;
            margin-top: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pay-method {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-full);
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .pay-method:hover, .pay-method.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-subtle);
        }
        .pay-method i { font-size: 1rem; }

        /* Guarantee strip */
        .paywall__guarantee {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 48px;
            flex-wrap: wrap;
        }
        .paywall__guarantee-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.82rem;
            color: var(--text-tertiary);
        }
        .paywall__guarantee-item i {
            font-size: 1rem;
            color: var(--success);
        }

        /* ========================================
           LISTING DETAIL PAGE
           ======================================== */
        .listing-detail { padding: calc(var(--nav-height) + 32px) 0 80px; }
        .listing-detail__gallery {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: 32px;
            max-height: 450px;
        }
        .listing-detail__gallery img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .listing-detail__gallery img:hover { opacity: 0.9; }
        .listing-detail__gallery--multi {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        .listing-detail__gallery--multi img:first-child {
            grid-row: 1 / 3;
        }
        .listing-detail__thumbs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .listing-detail__thumb {
            width: 80px; height: 60px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
            border: 2px solid transparent;
            transition: border-color var(--transition-fast);
        }
        .listing-detail__thumb.active { border-color: var(--accent); }
        .listing-detail__thumb img { width: 100%; height: 100%; object-fit: cover; }
        .listing-detail__content {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 32px;
            align-items: start;
        }
        .listing-detail__info { }
        .listing-detail__badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .listing-detail__badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .listing-detail__badge--verified { background: rgba(34,197,94,0.1); color: #16a34a; }
        .listing-detail__badge--unverified { background: rgba(245,158,11,0.1); color: #d97706; }
        .listing-detail__badge--individual { background: var(--bg-secondary); color: var(--text-secondary); }
        .listing-detail__badge--dealer { background: rgba(99,102,241,0.1); color: #6366f1; }
        .listing-detail__title {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .listing-detail__price {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 20px;
        }
        .listing-detail__specs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .listing-detail__spec {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 14px;
            text-align: center;
        }
        .listing-detail__spec-label {
            font-size: 0.72rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .listing-detail__spec-value {
            font-weight: 700;
            font-size: 0.92rem;
        }
        .listing-detail__desc {
            font-size: 0.92rem;
            line-height: 1.7;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .listing-detail__sidebar {
            position: sticky;
            top: calc(var(--nav-height) + 24px);
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 28px;
        }
        .listing-detail__sidebar h3 {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 16px;
        }
        .listing-detail__seller-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-default);
        }
        .listing-detail__sidebar .btn { width: 100%; margin-bottom: 10px; }
        .listing-detail__sidebar .btn:last-child { margin-bottom: 0; }
        .listing-detail__deposit-info {
            margin-top: 16px;
            padding: 14px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .listing-detail__deposit-info strong { color: var(--text-primary); }
        .listing-detail__meta {
            margin-top: 16px;
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }
        @media (max-width: 768px) {
            .listing-detail__content { grid-template-columns: 1fr; }
            .listing-detail__sidebar { position: static; }
            .listing-detail__specs { grid-template-columns: repeat(2, 1fr); }
            .listing-detail__gallery { max-height: 280px; }
            .listing-detail__gallery--multi { grid-template-columns: 1fr; grid-template-rows: auto; }
            .listing-detail__gallery--multi img:first-child { grid-row: auto; }
        }

        /* ========================================
           ADMIN DASHBOARD
           ======================================== */
        .admin { padding: calc(var(--nav-height) + 40px) 0 80px; }
        .admin__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .admin__stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        .admin__stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 24px;
        }
        .admin__stat-label {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .admin__stat-value {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 800;
        }
        .admin__section {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .admin__section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin__section-title {
            font-family: var(--font-display);
            font-size: 1.05rem;
            font-weight: 700;
        }
        .admin__table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin__table th {
            background: var(--bg-secondary);
            text-align: left;
            padding: 12px 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .admin__table td {
            padding: 14px 20px;
            font-size: 0.88rem;
            border-bottom: 1px solid var(--border-light);
        }
        .admin__table tr:last-child td { border-bottom: none; }
        .admin__table tr:hover td {
            background: var(--bg-secondary);
        }
        .admin__badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .admin__badge--pending {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
        .admin__badge--awaiting {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        .admin__badge--completed {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .admin__badge--failed {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .admin__actions {
            display: flex;
            gap: 6px;
        }
        .admin__btn {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        .admin__btn--approve {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.2);
        }
        .admin__btn--approve:hover { background: rgba(34, 197, 94, 0.2); }
        .admin__btn--reject {
            background: rgba(239, 68, 68, 0.08);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.15);
        }
        .admin__btn--reject:hover { background: rgba(239, 68, 68, 0.15); }
        .admin__no-data {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        /* User bar (top of paywall after login) */
        .user-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: 16px 24px;
            margin-bottom: 32px;
        }
        .user-bar__info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-bar__avatar {
            width: 40px; height: 40px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent);
        }
        .user-bar__name { font-weight: 600; font-size: 0.9rem; }
        .user-bar__tier {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }
        .user-bar__actions { display: flex; gap: 8px; }

        /* ========================================
           SCROLL ANIMATIONS
           ======================================== */
        .reveal {
            opacity: 0;
            transform: translateY(24px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 1024px) {
            .hero__grid { grid-template-columns: 1fr; gap: 40px; }
            .hero__featured { max-width: 500px; }
            .about__grid { grid-template-columns: 1fr; }
            .contact__grid { grid-template-columns: 1fr; }
            .features__grid { grid-template-columns: 1fr 1fr; }
            .sourcing-steps { grid-template-columns: 1fr 1fr; }
            .paywall__grid { grid-template-columns: repeat(2, 1fr); }
            .paywall__grid--dealer { grid-template-columns: repeat(2, 1fr); }
            .admin__stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            :root { --nav-height: 64px; }
            .nav__links { display: none; }
            .nav__hamburger { display: flex; }
            .hero { padding-top: calc(var(--nav-height) + 32px); padding-bottom: 48px; }
            .hero__stats { gap: 24px; }
            .hero__float-card { display: none; }
            .features__grid { grid-template-columns: 1fr; }
            .sourcing-steps { grid-template-columns: 1fr; }
            .car-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filter-group { min-width: 0; width: 100%; }
            .footer__inner { flex-direction: column; text-align: center; }
            .footer__links { justify-content: center; }
            .form-card { padding: 24px; }
            .paywall__grid { grid-template-columns: 1fr; max-width: 400px; margin: 0 auto; }
            .paywall__grid--dealer { grid-template-columns: 1fr; max-width: 400px; margin: 0 auto; }
            .commission__rates { grid-template-columns: 1fr; }
            .admin__stats { grid-template-columns: 1fr; }
            .admin__table { font-size: 0.8rem; }
            .admin__table th, .admin__table td { padding: 10px 12px; }
            .login-card { padding: 32px 24px; }
            .user-bar { flex-direction: column; gap: 12px; text-align: center; }
            .user-bar__info { flex-direction: column; }
        }
        @media (max-width: 480px) {
            .container { padding: 0 16px; }
            .hero__actions { flex-direction: column; }
            .hero__actions .btn { width: 100%; }
            .brands-strip__inner { gap: 24px; }
            .wa-float { bottom: 20px; right: 20px; }
            .wa-float__btn { width: 52px; height: 52px; font-size: 1.3rem; }
            .paywall__guarantee { gap: 16px; flex-direction: column; align-items: center; }
            .tier-card { padding: 24px 20px; }
        }
    </style>
</head>
<body>

    <!-- ===== SPLASH SCREEN ===== -->
    <div class="splash" id="splashScreen">
        <div class="splash__logo">
            PrimeDrive<span class="splash__dot"></span>
        </div>
        <div class="splash__tagline">Botswana's Trusted Car Marketplace</div>
        <div class="splash__loader"></div>
        <div class="splash__car-icon">
            <svg viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>
        </div>
    </div>
    <script>
    // Splash dismissal — runs immediately, no dependency on DOMContentLoaded
    (function() {
        var done = false;
        function kill() {
            if (done) return;
            done = true;
            var s = document.getElementById('splashScreen');
            if (!s) return;
            s.classList.add('hide');
            setTimeout(function() { try { s.remove(); } catch(e){} }, 500);
        }
        // Dismiss after 2s (animations finish), hard cap at 4s
        setTimeout(kill, 2000);
        setTimeout(kill, 4000);
    })();
    </script>

    <!-- ===== NAVIGATION ===== -->
    <nav class="nav" id="navbar">
        <div class="container nav__inner">
            <div class="nav__logo" onclick="navigate('home')">
                PrimeDrive<span class="nav__logo-dot"></span>
            </div>
            <ul class="nav__links">
                <li><a class="nav__link active" data-nav="home" onclick="navigate('home')">Home</a></li>
                <li><a class="nav__link" data-nav="buy" onclick="navigate('buy')">Buy</a></li>
                <li><a class="nav__link" data-nav="rent" onclick="navigate('rent')">Rent</a></li>
                <li><a class="nav__link" data-nav="sell" onclick="navigate('sell')">Sell</a></li>
                <li><a class="nav__link" data-nav="sourcing" onclick="navigate('sourcing')">Sourcing</a></li>
                <li><a class="nav__link" data-nav="about" onclick="navigate('about')">About</a></li>
                <li><a class="nav__link" data-nav="contact" onclick="navigate('contact')">Contact</a></li>
                <li><a class="nav__link" data-nav="mylistings" onclick="navigate('mylistings')" id="navMyListingsLink" style="display:none;">My Listings</a></li>
            </ul>
            <div class="nav__actions">
                <div class="nav__theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <i class="bi bi-moon" id="themeIcon"></i>
                </div>
                <a class="btn btn--ghost btn--sm" onclick="navigate('messages')" style="display:none;" id="navMessagesBtn" title="Messages">
                    <i class="bi bi-chat-dots"></i> <span class="msg-badge" id="navMsgBadge" style="display:none;"></span>
                </a>
                <div style="position:relative;display:none;" id="navNotifWrap">
                    <a class="btn btn--ghost btn--sm" onclick="showNotifPanel()" title="Notifications" style="position:relative;">
                        <i class="bi bi-bell"></i>
                        <span class="msg-badge" id="navNotifBadge" style="display:none;"></span>
                    </a>
                    <div id="notifPanel" style="display:none;position:absolute;right:0;top:42px;width:340px;max-height:400px;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-default);border-radius:var(--radius-md);box-shadow:0 8px 24px rgba(0,0,0,0.12);z-index:999;"></div>
                </div>
                <button class="btn btn--primary btn--sm" id="navLoginBtn" onclick="showLogin()">
                    <i class="bi bi-person"></i> Login
                </button>
                <button class="btn btn--secondary btn--sm" id="navUserBtn" onclick="navigate('dashboard')" style="display:none;">
                    <i class="bi bi-grid"></i> Dashboard
                </button>
                <div class="nav__hamburger" id="hamburger" onclick="toggleMobileNav()">
                    <div class="nav__hamburger-icon">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mobileNav">
        <a class="mobile-nav__link active" data-nav="home" onclick="navigate('home'); toggleMobileNav();">
            <i class="bi bi-house"></i> Home
        </a>
        <a class="mobile-nav__link" data-nav="buy" onclick="navigate('buy'); toggleMobileNav();">
            <i class="bi bi-car-front"></i> Buy Cars
        </a>
        <a class="mobile-nav__link" data-nav="rent" onclick="navigate('rent'); toggleMobileNav();">
            <i class="bi bi-key"></i> Rent Cars
        </a>
        <a class="mobile-nav__link" data-nav="sell" onclick="navigate('sell'); toggleMobileNav();">
            <i class="bi bi-tag"></i> Sell Your Car
        </a>
        <a class="mobile-nav__link" data-nav="sourcing" onclick="navigate('sourcing'); toggleMobileNav();">
            <i class="bi bi-search"></i> Car Sourcing
        </a>
        <a class="mobile-nav__link" data-nav="about" onclick="navigate('about'); toggleMobileNav();">
            <i class="bi bi-info-circle"></i> About Us
        </a>
        <a class="mobile-nav__link" data-nav="contact" onclick="navigate('contact'); toggleMobileNav();">
            <i class="bi bi-envelope"></i> Contact
        </a>
        <div class="mobile-nav__divider"></div>
        <a class="btn btn--primary btn--full" onclick="navigate('messages'); toggleMobileNav();" style="margin-top:8px;display:none;" id="mobileMessagesBtn">
            <i class="bi bi-chat-dots"></i> Messages
        </a>
        <a class="mobile-nav__link" id="mobileLoginBtn" onclick="showLogin(); toggleMobileNav();">
            <i class="bi bi-person"></i> Login
        </a>
        <a class="mobile-nav__link" id="mobileDashBtn" onclick="navigate('dashboard'); toggleMobileNav();" style="display:none;">
            <i class="bi bi-grid"></i> Dashboard
        </a>
        <a class="mobile-nav__link" id="mobileMyListingsBtn" onclick="navigate('mylistings'); toggleMobileNav();" style="display:none;">
            <i class="bi bi-list-ul"></i> My Listings
        </a>
    </div>


    <!-- ===== LOGIN OVERLAY ===== -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <div class="login-card__close" onclick="hideLogin()"><i class="bi bi-x-lg"></i></div>
            <div class="login-card__logo">PrimeDrive<span class="nav__logo-dot"></span></div>
            <div class="login-card__subtitle">Sign in to manage your listings</div>

            <div class="login-card__error" id="loginError"></div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-group__label">Email</label>
                    <input type="email" class="form-control" id="loginEmail" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Password</label>
                    <div class="input-with-icon">
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password" required minlength="6">
                        <span class="input-toggle" onclick="togglePasswordVis()"><i class="bi bi-eye" id="passEyeIcon"></i></span>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <button type="submit" class="btn btn--primary btn--full" id="loginSubmitBtn">
                        <i class="bi bi-arrow-right"></i> Sign In
                    </button>
                </div>
            </form>

            <div class="login-card__divider">or</div>

            <button class="btn btn--google btn--full" onclick="handleGoogleLogin()" id="googleLoginBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" style="margin-right:8px;flex-shrink:0;"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Continue with Google
            </button>

            <div style="height:8px;"></div>

            <button class="btn btn--outline btn--full" onclick="switchToSignup()" id="loginSignupSwitch">
                <i class="bi bi-person-plus"></i> Create Account
            </button>

            <!-- Signup form (hidden by default) -->
            <form id="signupForm" onsubmit="handleSignup(event)" style="display: none;">
                <div class="form-group">
                    <label class="form-group__label">Full Name</label>
                    <input type="text" class="form-control" id="signupName" placeholder="Your full name" required>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Email</label>
                    <input type="email" class="form-control" id="signupEmail" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Password</label>
                    <input type="password" class="form-control" id="signupPassword" placeholder="Min 6 characters" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-group__label">Phone (optional)</label>
                    <input type="tel" class="form-control" id="signupPhone" placeholder="+267...">
                </div>
                <div class="form-group">
                    <label class="form-group__label">Seller Contact (optional)</label>
                    <input type="tel" class="form-control" id="signupWhatsApp" placeholder="+267...">
                </div>
                <div style="margin-top: 24px;">
                    <button type="submit" class="btn btn--primary btn--full" id="signupSubmitBtn">
                        <i class="bi bi-check-lg"></i> Create Account
                    </button>
                </div>
            </form>

            <div class="login-card__alt" id="loginAltText">
                New here? Create an account to start listing.
            </div>
        </div>
    </div>


    <!-- ============================= -->
    <!-- PAGE: HOME                    -->
    <!-- ============================= -->
    <div class="page active" id="page-home">
        <section class="hero">
            <div class="hero__bg-pattern"></div>
            <div class="container">
                <div class="hero__grid">
                    <div class="hero__content">
                        <div class="hero__badge">
                            <i class="bi bi-patch-check-fill"></i>
                            Verified Marketplace
                        </div>
                        <h1 class="heading-xl hero__title">
                            Buy, Rent &amp; Sell<br>
                            <span class="hero__title-accent">Trusted Cars</span><br>
                            in Botswana
                        </h1>
                        <p class="hero__desc">
                            Your trusted car marketplace in Botswana. We source quality pre-owned vehicles
                            locally, ensuring transparent deals and easy communication.
                        </p>
                        <div class="hero__actions">
                            <button class="btn btn--primary btn--lg" onclick="navigate('buy')">
                                <i class="bi bi-car-front"></i> Browse Cars
                            </button>
                            <button class="btn btn--outline btn--lg" onclick="navigate('sell')">
                                <i class="bi bi-plus-circle"></i> List Your Car
                            </button>
                        </div>
                        <div class="hero__stats">
                            <div>
                                <div class="hero__stat-value">Local</div>
                                <div class="hero__stat-label">Sourcing</div>
                            </div>
                            <div>
                                <div class="hero__stat-value">100%</div>
                                <div class="hero__stat-label">Verified</div>
                            </div>
                            <div>
                                <div class="hero__stat-value">&lt;24h</div>
                                <div class="hero__stat-label">Response</div>
                            </div>
                        </div>
                    </div>
                    <div class="hero__featured">
                        <div class="hero__car-card">
                            <div class="hero__car-image" style="height:400px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px;">
                                <div style="width:80px; height:80px; background:var(--accent-light); border-radius:var(--radius-md); display:flex; align-items:center; justify-content:center; font-size:2rem; color:var(--accent);">
                                    <i class="bi bi-car-front"></i>
                                </div>
                                <div style="text-align:center; padding:0 24px;">
                                    <div class="hero__car-name" style="margin-bottom:12px;">Looking for your next car?</div>
                                    <p class="body-sm" style="margin-bottom:20px;">We source quality vehicles locally in Botswana. Browse the marketplace or tell us what you need.</p>
                                    <button onclick="navigate('buy')" class="btn btn--primary btn--sm">
                                        <i class="bi bi-search"></i> Browse Cars
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Brands -->
        <div class="brands-strip">
            <div class="container brands-strip__inner">
                <span class="brands-strip__item">Toyota</span>
                <span class="brands-strip__item">BMW</span>
                <span class="brands-strip__item">Mercedes-Benz</span>
                <span class="brands-strip__item">Ford</span>
                <span class="brands-strip__item">Volkswagen</span>
                <span class="brands-strip__item">Hyundai</span>
                <span class="brands-strip__item">Nissan</span>
                <span class="brands-strip__item">Honda</span>
            </div>
        </div>

        <!-- Featured Listings -->
        <section class="featured-listings" id="featuredSection">
            <div class="container">
                <div class="featured-listings__header">
                    <div>
                        <div class="label"><i class="bi bi-fire"></i> Fresh on PrimeDrive</div>
                        <h2 class="heading-lg">Featured Listings</h2>
                    </div>
                    <button class="btn btn--outline btn--sm" onclick="navigate('buy')">
                        View All <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
                <div class="car-grid" id="featuredGrid">
                    <div style="text-align:center; padding:48px 0; color:var(--text-tertiary); grid-column:1/-1;">
                        <i class="bi bi-arrow-repeat spin" style="font-size:1.5rem;"></i>
                        <p style="margin-top:8px;">Loading listings...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features -->
        <section class="features">
            <div class="container">
                <div class="features__header">
                    <div class="label"><i class="bi bi-lightning-charge-fill"></i> Why PrimeDrive</div>
                    <h2 class="heading-lg">The smarter way to buy &amp; sell cars</h2>
                    <p class="body-lg">We built PrimeDrive to solve the biggest problems in Botswana's used car market.</p>
                </div>
                <div class="features__grid">
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-shield-check"></i></div>
                        <div class="feature-card__title">Scam-Free Deals</div>
                        <div class="feature-card__desc">Every vehicle is verified before listing. We protect you from fraud so you buy with total confidence.</div>
                    </div>
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-lightning-charge"></i></div>
                        <div class="feature-card__title">Fast Turnaround</div>
                        <div class="feature-card__desc">From inquiry to keys in hand — we close deals fast so you're on the road sooner, not later.</div>
                    </div>
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-chat-dots"></i></div>
                        <div class="feature-card__title">In-App Messaging</div>
                        <div class="feature-card__desc">Message sellers directly inside PrimeDrive. Quick responses and transparent communication, all in one place.</div>
                    </div>
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-key"></i></div>
                        <div class="feature-card__title">Rentals Available</div>
                        <div class="feature-card__desc">Need a car temporarily? Browse our rental fleet for daily, weekly, or monthly bookings across Botswana.</div>
                    </div>
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-globe-americas"></i></div>
                        <div class="feature-card__title">Car Sourcing</div>
                        <div class="feature-card__desc">Can't find what you're looking for? We source quality vehicles locally in Botswana from trusted sellers.</div>
                    </div>
                    <div class="feature-card reveal">
                        <div class="feature-card__icon"><i class="bi bi-geo-alt"></i></div>
                        <div class="feature-card__title">Local Expertise</div>
                        <div class="feature-card__desc">Based in Gaborone, we understand the Botswana market and connect buyers and sellers nationwide.</div>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: BUY CARS                -->
    <!-- ============================= -->
    <div class="page" id="page-buy">
        <section class="listings">
            <div class="container">
                <div class="listings__header">
                    <div class="listings__header-text">
                        <div class="label"><i class="bi bi-car-front-fill"></i> Buy Cars</div>
                        <h1 class="heading-lg">Cars for Sale</h1>
                        <div class="listings__count" id="buyCount">Showing 0 cars</div>
                    </div>
                </div>

                <div class="filters" id="buyFilters">
                    <div class="filter-group">
                        <label>Brand</label>
                        <select class="filter-select" id="buyFilterBrand" onchange="applyBuyFilters()">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Price Range</label>
                        <select class="filter-select" id="buyFilterPrice" onchange="applyBuyFilters()">
                            <option value="">Any Price</option>
                            <option value="0-100000">Under P100,000</option>
                            <option value="100000-200000">P100k &ndash; P200k</option>
                            <option value="200000-400000">P200k &ndash; P400k</option>
                            <option value="400000-999999999">P400k+</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Year</label>
                        <select class="filter-select" id="buyFilterYear" onchange="applyBuyFilters()">
                            <option value="">Any Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Transmission</label>
                        <select class="filter-select" id="buyFilterTrans" onchange="applyBuyFilters()">
                            <option value="">Any</option>
                            <option value="Automatic">Automatic</option>
                            <option value="Manual">Manual</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Location</label>
                        <select class="filter-select" id="buyFilterLocation" onchange="applyBuyFilters()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group filter-reset" style="flex:0;">
                        <label>&nbsp;</label>
                        <button class="btn btn--ghost btn--sm" onclick="resetBuyFilters()"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                    </div>
                </div>

                <div class="car-grid" id="buyGrid"></div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: RENT CARS               -->
    <!-- ============================= -->
    <div class="page" id="page-rent">
        <section class="listings">
            <div class="container">
                <div class="listings__header">
                    <div class="listings__header-text">
                        <div class="label"><i class="bi bi-key-fill"></i> Rent Cars</div>
                        <h1 class="heading-lg">Cars for Rent</h1>
                        <div class="listings__count" id="rentCount">Showing 0 cars</div>
                    </div>
                </div>

                <div class="filters" id="rentFilters">
                    <div class="filter-group">
                        <label>Brand</label>
                        <select class="filter-select" id="rentFilterBrand" onchange="applyRentFilters()">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Daily Rate</label>
                        <select class="filter-select" id="rentFilterPrice" onchange="applyRentFilters()">
                            <option value="">Any Rate</option>
                            <option value="0-500">Under P500/day</option>
                            <option value="500-1000">P500 &ndash; P1,000/day</option>
                            <option value="1000-999999">P1,000+/day</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Year</label>
                        <select class="filter-select" id="rentFilterYear" onchange="applyRentFilters()">
                            <option value="">Any Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Transmission</label>
                        <select class="filter-select" id="rentFilterTrans" onchange="applyRentFilters()">
                            <option value="">Any</option>
                            <option value="Automatic">Automatic</option>
                            <option value="Manual">Manual</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Location</label>
                        <select class="filter-select" id="rentFilterLocation" onchange="applyRentFilters()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group filter-reset" style="flex:0;">
                        <label>&nbsp;</label>
                        <button class="btn btn--ghost btn--sm" onclick="resetRentFilters()"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
                    </div>
                </div>

                <div class="car-grid" id="rentGrid"></div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: SELL YOUR CAR           -->
    <!-- ============================= -->
    <div class="page" id="page-sell">
        <section class="form-page">
            <div class="container">
                <div class="form-page__header">
                    <div class="label"><i class="bi bi-tag-fill"></i> Sell Your Car</div>
                    <h1 class="heading-lg">List your vehicle</h1>
                    <p class="body-lg">Fill in the details and upload photos. Your listing will appear on the PrimeDrive marketplace for buyers to browse.</p>
                </div>

                <div class="form-card">
                    <form id="sellForm" onsubmit="submitSellForm(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-group__label">Car Brand *</label>
                                <input type="text" class="form-control" id="sellBrand" placeholder="e.g. Toyota" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Model *</label>
                                <input type="text" class="form-control" id="sellModel" placeholder="e.g. Hilux 2.8 GD-6" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Year *</label>
                                <input type="number" class="form-control" id="sellYear" placeholder="e.g. 2020" min="1990" max="2026" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Mileage (km) *</label>
                                <input type="number" class="form-control" id="sellMileage" placeholder="e.g. 45000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Transmission *</label>
                                <select class="form-control" id="sellTransmission" required>
                                    <option value="">Select</option>
                                    <option value="Automatic">Automatic</option>
                                    <option value="Manual">Manual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Condition *</label>
                                <select class="form-control" id="sellCondition" required>
                                    <option value="">Select condition</option>
                                    <option value="Excellent">Excellent</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Needs Work">Needs Work</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Asking Price (BWP) *</label>
                                <input type="number" class="form-control" id="sellPrice" placeholder="e.g. 250000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Location *</label>
                                <input type="text" class="form-control" id="sellLocation" placeholder="e.g. Gaborone" required>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-group__label">Description</label>
                                <textarea class="form-control" id="sellNotes" placeholder="Features, service history, reason for selling..." rows="3"></textarea>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-group__label">Photos (up to 10)</label>
                                <div class="upload-area" id="uploadArea">
                                    <input type="file" accept="image/*" multiple id="photoInput" onchange="handlePhotos(event)">
                                    <div class="upload-area__icon"><i class="bi bi-cloud-arrow-up"></i></div>
                                    <div class="upload-area__text">Click or drag to upload photos</div>
                                    <div class="upload-area__hint">Max 10 photos &middot; JPG, PNG</div>
                                </div>
                                <div class="upload-previews" id="photoPreviews"></div>
                            </div>
                            <div class="form-group form-group--full">
                                <button type="submit" class="btn btn--primary btn--lg btn--full" id="sellSubmitBtn">
                                    <i class="bi bi-plus-circle"></i> Publish Listing
                                </button>
                                <p class="body-sm" style="text-align:center; margin-top:10px; color:var(--text-tertiary);">Your listing will appear on the marketplace once submitted.</p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: CAR SOURCING            -->
    <!-- ============================= -->
    <div class="page" id="page-sourcing">
        <section class="form-page">
            <div class="container">
                <div style="text-align:center; max-width:600px; margin:0 auto;">
                    <div class="label" style="justify-content:center;"><i class="bi bi-search-heart-fill"></i> Car Sourcing</div>
                    <h1 class="heading-lg" style="margin: 8px 0 12px;">We find the car for you</h1>
                    <p class="body-lg" style="margin: 0 auto;">Can't find what you're looking for? Tell us your dream car and we'll source it locally in Botswana from our trusted network.</p>
                </div>

                <div class="sourcing-steps">
                    <div class="sourcing-step reveal">
                        <div class="sourcing-step__number">01</div>
                        <div class="sourcing-step__icon"><i class="bi bi-pencil-square"></i></div>
                        <div class="sourcing-step__title">Describe It</div>
                        <div class="sourcing-step__desc">Tell us the brand, model, year range, and your budget. Be as specific as you like.</div>
                    </div>
                    <div class="sourcing-step reveal">
                        <div class="sourcing-step__number">02</div>
                        <div class="sourcing-step__icon"><i class="bi bi-globe"></i></div>
                        <div class="sourcing-step__title">We Search</div>
                        <div class="sourcing-step__desc">We search locally in Botswana through our trusted network of sellers to find your perfect match.</div>
                    </div>
                    <div class="sourcing-step reveal">
                        <div class="sourcing-step__number">03</div>
                        <div class="sourcing-step__icon"><i class="bi bi-hand-thumbs-up"></i></div>
                        <div class="sourcing-step__title">You Decide</div>
                        <div class="sourcing-step__desc">We present the options, you choose. No pressure, no hidden fees, just honest sourcing.</div>
                    </div>
                </div>

                <div class="form-card" style="margin: 0 auto;">
                    <form id="sourcingForm" onsubmit="submitSourcingForm(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-group__label">Preferred Brand *</label>
                                <input type="text" class="form-control" id="srcBrand" placeholder="e.g. BMW" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Model *</label>
                                <input type="text" class="form-control" id="srcModel" placeholder="e.g. X5" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Year Range *</label>
                                <input type="text" class="form-control" id="srcYear" placeholder="e.g. 2018 - 2022" required>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Budget (BWP) *</label>
                                <input type="text" class="form-control" id="srcBudget" placeholder="e.g. 300,000 - 500,000" required>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-group__label">Your Name *</label>
                                <input type="text" class="form-control" id="srcName" placeholder="Your full name" required>
                            </div>
                            <div class="form-group form-group--full">
                                <label class="form-group__label">Preferences</label>
                                <textarea class="form-control" id="srcNotes" placeholder="Color, features, transmission preference, etc."></textarea>
                            </div>
                            <div class="form-group form-group--full">
                                <button type="submit" class="btn btn--primary btn--lg btn--full">
                                    <i class="bi bi-send"></i> Submit Request
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: ABOUT US                -->
    <!-- ============================= -->
    <div class="page" id="page-about">
        <section class="about">
            <div class="container">
                <div class="about__grid">
                    <div class="about__content">
                        <div class="label"><i class="bi bi-building"></i> Our Story</div>
                        <h1 class="heading-lg">About PrimeDrive</h1>
                        <p class="about__text">
                            Hi, I'm Thatayotlhe Tsenang, a 21-year-old second-year student at UB. I started PrimeDrive to solve a problem I noticed in Botswana's car market.
                        </p>
                        <p class="about__text">
                            The goal with this platform is simple: reduce the friction between car buyers and sellers. Instead of actively searching through dozens of online posts and unclear listings, everything is in one place &mdash; easy to browse, easy to contact sellers, and transparent.
                        </p>
                        <p class="about__text">
                            Based in Gaborone, I'm building PrimeDrive to connect buyers and sellers across Botswana. Whether you're looking for your first car or ready to sell, I'm here to make the process easier.
                        </p>
                        <div class="about__values">
                            <div class="about__value reveal">
                                <div class="about__value-icon"><i class="bi bi-shield-check"></i></div>
                                <div>
                                    <div class="about__value-title">Trust First</div>
                                    <div class="about__value-desc">Every listing is reviewed. We protect both buyers and sellers from fraud and misrepresentation.</div>
                                </div>
                            </div>
                            <div class="about__value reveal">
                                <div class="about__value-icon"><i class="bi bi-lightning-charge"></i></div>
                                <div>
                                    <div class="about__value-title">Fast Deals</div>
                                    <div class="about__value-desc">Direct communication with sellers means instant responses and quick closings. No waiting around.</div>
                                </div>
                            </div>
                            <div class="about__value reveal">
                                <div class="about__value-icon"><i class="bi bi-gem"></i></div>
                                <div>
                                    <div class="about__value-title">Quality Vehicles</div>
                                    <div class="about__value-desc">We only list cars that meet our standards. No junk, no hidden damage, no surprises.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="about__visual reveal">
                        <div class="about__visual-body" style="padding: 48px 32px; text-align: center;">
                            <div style="width: 80px; height: 80px; background: var(--accent-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent); margin: 0 auto 24px;">
                                <i class="bi bi-car-front-fill"></i>
                            </div>
                            <h3 class="heading-md" style="margin-bottom: 16px;">Building Something Real</h3>
                            <p class="body-sm" style="margin-bottom: 32px; max-width: 400px; margin-left: auto; margin-right: auto;">
                                PrimeDrive is a work in progress. I'm actively building this platform to make car buying and selling in Botswana more accessible and transparent.
                            </p>
                            <div class="about__visual-stat">
                                <div class="about__visual-stat-item">
                                    <div class="about__visual-stat-value">Local</div>
                                    <div class="about__visual-stat-label">Botswana</div>
                                </div>
                                <div class="about__visual-stat-item">
                                    <div class="about__visual-stat-value">100%</div>
                                    <div class="about__visual-stat-label">Verified</div>
                                </div>
                                <div class="about__visual-stat-item">
                                    <div class="about__visual-stat-value">Fast</div>
                                    <div class="about__visual-stat-label">Service</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: CONTACT                 -->
    <!-- ============================= -->
    <div class="page" id="page-contact">
        <section class="contact">
            <div class="container">
                <div class="contact__header">
                    <div class="label"><i class="bi bi-chat-dots-fill"></i> Get in Touch</div>
                    <h1 class="heading-lg">Contact Us</h1>
                    <p class="body-lg">Have a question or ready to deal? Reach out and we'll respond within 24 hours.</p>
                </div>
                <div class="contact__grid">
                    <div class="contact__card">
                        <div class="contact__item">
                            <div class="contact__item-icon"><i class="bi bi-telephone"></i></div>
                            <div>
                                <div class="contact__item-label">Phone</div>
                                <div class="contact__item-value"><a href="tel:+26777625997">+267 77 625 997</a></div>
                            </div>
                        </div>
                        <div class="contact__item">
                            <div class="contact__item-icon"><i class="bi bi-headset"></i></div>
                            <div>
                                <div class="contact__item-label">Support</div>
                                <div class="contact__item-value"><a href="https://wa.me/26777625997" target="_blank">Chat with us now</a></div>
                            </div>
                        </div>
                        <div class="contact__item">
                            <div class="contact__item-icon"><i class="bi bi-envelope"></i></div>
                            <div>
                                <div class="contact__item-label">Email</div>
                                <div class="contact__item-value"><a href="/cdn-cgi/l/email-protection#c494b6ada9a180b6adb2a1f6f284a3a9a5ada8eaa7aba9"><span class="__cf_email__" data-cfemail="8fdffde6e2eacbfde6f9eabdb9cfe8e2eee6e3a1ece0e2">[email&#160;protected]</span></a></div>
                            </div>
                        </div>
                        <div class="contact__item">
                            <div class="contact__item-icon"><i class="bi bi-geo-alt"></i></div>
                            <div>
                                <div class="contact__item-label">Location</div>
                                <div class="contact__item-value">Gaborone, Botswana</div>
                            </div>
                        </div>
                        <div class="contact__socials">
                            <a href="https://wa.me/26777625997" target="_blank" class="contact__social-link" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                            <a href="#" class="contact__social-link" title="Facebook"><i class="bi bi-facebook"></i></a>
                            <a href="#" class="contact__social-link" title="Instagram"><i class="bi bi-instagram"></i></a>
                            <a href="#" class="contact__social-link" title="TikTok"><i class="bi bi-tiktok"></i></a>
                            <a href="#" class="contact__social-link" title="Twitter / X"><i class="bi bi-twitter-x"></i></a>
                        </div>
                    </div>
                    <div class="contact__map">
                        <div class="contact__map-pin"><i class="bi bi-geo-alt-fill"></i></div>
                        <div class="contact__map-text">Gaborone, Botswana</div>
                        <div class="body-sm">Serving all major cities across Botswana</div>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: DASHBOARD (Subscription Paywall + Admin) -->
    <!-- ============================= -->
    <div class="page" id="page-dashboard">

        <!-- Subscription Paywall Section -->
        <section class="paywall" id="paywallSection">
            <div class="container">

                <!-- User bar (shows when logged in) -->
                <div class="user-bar" id="userBar" style="display: none;">
                    <div class="user-bar__info">
                        <div class="user-bar__avatar" id="userAvatar">A</div>
                        <div>
                            <div class="user-bar__name" id="userDisplayName">Admin</div>
                            <div class="user-bar__tier" id="userTierDisplay">Free Tier &middot; 0/1 Listings</div>
                        </div>
                    </div>
                    <div class="user-bar__actions">
                        <button class="btn btn--primary btn--sm" onclick="navigate('mylistings')">
                            <i class="bi bi-list-ul"></i> My Listings
                        </button>
                        <button class="btn btn--ghost btn--sm" onclick="navigate('messages')">
                            <i class="bi bi-chat-dots"></i> Messages
                        </button>
                        <button class="btn btn--secondary btn--sm" onclick="navigate('sell')">
                            <i class="bi bi-plus-circle"></i> New Listing
                        </button>
                        <button class="btn btn--ghost btn--sm" onclick="handleLogout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- My Purchases -->
                <div id="buyerPurchasesSection" style="margin:24px 0;display:none;">
                    <h3 class="heading-sm" style="margin-bottom:12px;"><i class="bi bi-bag-check"></i> My Purchases</h3>
                    <div class="admin__table-wrap">
                        <table class="admin__table">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Vehicle</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="buyerPurchasesBody">
                                <tr><td colspan="7" class="admin__no-data">No purchases yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="paywall__header">
                    <div class="label"><i class="bi bi-rocket-takeoff-fill"></i> Choose Your Plan</div>
                    <h1 class="heading-lg">Plans that grow with you</h1>
                    <p class="body-lg">Whether you're selling your personal car or running a dealership, we have a plan that fits. No hidden fees, cancel anytime.</p>

                    <div class="paywall__toggle">
                        <div class="paywall__toggle-btn active" onclick="switchPlanTab('individual')" id="tabIndividual">
                            <i class="bi bi-person"></i> Individual Sellers
                        </div>
                        <div class="paywall__toggle-btn" onclick="switchPlanTab('dealer')" id="tabDealer">
                            <i class="bi bi-building"></i> Dealerships
                        </div>
                    </div>
                </div>

                <!-- ====== INDIVIDUAL SELLER PLANS ====== -->
                <div class="paywall__panel active" id="panelIndividual">
                    <div class="paywall__grid" id="tiersGrid">

                        <!-- Free -->
                        <div class="tier-card reveal">
                            <div class="tier-card__inner">
                                <div class="tier-card__icon tier-card__icon--free"><i class="bi bi-person"></i></div>
                                <div class="tier-card__name">Free</div>
                                <div class="tier-card__desc">Test the waters with one listing</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P0</span>
                                    <span class="tier-card__period">forever</span>
                                </div>
                                <div class="tier-card__billing">No payment needed</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 1 active listing</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 30-day listing duration</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 3 photos per listing</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Customer support</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No featured placement</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No priority ranking</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No Verified badge</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No listing boosts</li>
                                </ul>
                                <div class="tier-card__cta" id="tierCtaFree">
                                    <div class="tier-card__current">
                                        <i class="bi bi-check2"></i> Current Plan
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic -->
                        <div class="tier-card reveal">
                            <div class="tier-card__inner">
                                <div class="tier-card__icon tier-card__icon--basic"><i class="bi bi-lightning"></i></div>
                                <div class="tier-card__name">Basic</div>
                                <div class="tier-card__desc">For casual sellers with a few cars</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P25</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">Billed monthly via mobile money</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 3 active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 60-day listing duration</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 6 photos per listing</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Edit listings anytime</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Priority Customer support</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No featured placement</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No Verified badge</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No listing boosts</li>
                                </ul>
                                <div class="tier-card__cta" id="tierCtaBasic">
                                    <button class="btn btn--secondary btn--full" onclick="initiatePurchase('basic')">
                                        Upgrade to Basic
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Standard (Popular) -->
                        <div class="tier-card tier-card--popular reveal" data-badge="Best Value">
                            <div class="tier-card__inner" style="padding-top: 16px;">
                                <div class="tier-card__icon tier-card__icon--standard"><i class="bi bi-star"></i></div>
                                <div class="tier-card__name">Standard</div>
                                <div class="tier-card__desc">For active sellers who want results</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P60</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">Just P6 per listing</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 10 active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 90-day listing duration</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 10 photos per listing</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Featured placement in search</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Priority search ranking</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Verified Seller" badge</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 1 listing boost per month</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Faster support response</li>
                                </ul>
                                <div class="tier-card__cta" id="tierCtaStandard">
                                    <button class="btn btn--primary btn--full" onclick="initiatePurchase('standard')">
                                        Upgrade to Standard
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Premium -->
                        <div class="tier-card reveal">
                            <div class="tier-card__inner">
                                <div class="tier-card__icon tier-card__icon--premium"><i class="bi bi-gem"></i></div>
                                <div class="tier-card__name">Premium</div>
                                <div class="tier-card__desc">Maximum visibility, maximum sales</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P100</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">Unlimited everything</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 90-day listing duration</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited photos</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Top placement in search</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Priority search ranking</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Verified Seller" badge</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 3 listing boosts per month</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 24/7 dedicated support</li>
                                </ul>
                                <div class="tier-card__cta" id="tierCtaPremium">
                                    <button class="btn btn--secondary btn--full" onclick="initiatePurchase('premium')">
                                        Upgrade to Premium
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ====== DEALERSHIP PLANS ====== -->
                <div class="paywall__panel" id="panelDealer">
                    <div class="paywall__grid paywall__grid--dealer">

                        <!-- Dealer Starter -->
                        <div class="tier-card reveal">
                            <div class="tier-card__inner">
                                <div class="tier-card__icon tier-card__icon--dealer-starter"><i class="bi bi-shop"></i></div>
                                <div class="tier-card__name">Dealer Starter</div>
                                <div class="tier-card__desc">Launch your dealership online</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P750</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">P37.50 per listing</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 20 active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Verified Dealership" badge</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited photos</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Priority placement in search</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 2 featured listings included</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Basic analytics (views &amp; clicks)</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Priority support</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No custom dealer profile</li>
                                    <li class="tier-card__feature tier-card__feature--disabled"><i class="bi bi-x-circle"></i> No lead tracking</li>
                                </ul>
                                <div class="tier-card__cta">
                                    <button class="btn btn--secondary btn--full" onclick="initiatePurchase('dealer_starter')">
                                        Get Dealer Starter
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Dealer Pro (Popular) -->
                        <div class="tier-card tier-card--popular reveal" data-badge="Most Popular">
                            <div class="tier-card__inner" style="padding-top: 16px;">
                                <div class="tier-card__icon tier-card__icon--dealer-pro"><i class="bi bi-shop-window"></i></div>
                                <div class="tier-card__name">Dealer Pro</div>
                                <div class="tier-card__desc">For growing dealerships that want leads</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P1,500</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">P25 per listing</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 60 active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Verified Dealership" badge</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited photos</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Homepage rotation placement</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 8 featured listings included</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Full analytics dashboard</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Lead tracking</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Custom dealership profile page</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Faster support response</li>
                                </ul>
                                <div class="tier-card__cta">
                                    <button class="btn btn--primary btn--full" onclick="initiatePurchase('dealer_pro')">
                                        Get Dealer Pro
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Dealer Elite -->
                        <div class="tier-card reveal">
                            <div class="tier-card__inner">
                                <div class="tier-card__icon tier-card__icon--dealer-elite"><i class="bi bi-trophy"></i></div>
                                <div class="tier-card__name">Dealer Elite</div>
                                <div class="tier-card__desc">Dominate the Botswana market</div>
                                <div class="tier-card__price">
                                    <span class="tier-card__amount">P2,500</span>
                                    <span class="tier-card__period">/month</span>
                                </div>
                                <div class="tier-card__billing">Unlimited everything</div>
                                <ul class="tier-card__features">
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited active listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Verified Dealership" badge</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited photos</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Permanent homepage placement</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Unlimited featured listings</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Full analytics + lead reports</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Lead tracking</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> Custom dealership profile page</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> "Top Dealer" homepage highlight</li>
                                    <li class="tier-card__feature"><i class="bi bi-check-circle-fill"></i> 24/7 dedicated account manager</li>
                                </ul>
                                <div class="tier-card__cta">
                                    <button class="btn btn--secondary btn--full" onclick="initiatePurchase('dealer_elite')">
                                        Get Dealer Elite
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ====== COMMISSION MODEL ====== -->
                <div class="commission reveal">
                    <div class="commission__header">
                        <div class="commission__icon"><i class="bi bi-percent"></i></div>
                        <div class="commission__title">Sales Commission</div>
                    </div>
                    <div class="commission__rates">
                        <div class="commission__rate">
                            <div class="commission__rate-value">5%</div>
                            <div class="commission__rate-label">Cars sold below P100,000</div>
                        </div>
                        <div class="commission__rate">
                            <div class="commission__rate-value">6.5%</div>
                            <div class="commission__rate-label">Cars sold above P100,000</div>
                        </div>
                    </div>
                    <div class="commission__note">
                        <strong>How it works:</strong> Commission is only charged when a sale is successfully completed through a lead generated on PrimeDrive. No sale, no commission. Your subscription fee covers listing access &mdash; commission is separate and only applies to closed deals.
                    </div>
                </div>

                <!-- ====== FAQ ====== -->
                <div class="pricing-faq reveal">
                    <div class="pricing-faq__title">Frequently Asked Questions</div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">What's the difference between subscription fees and commission?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>Your monthly subscription fee gives you access to list your cars on PrimeDrive with the perks included in your plan. Commission is a separate, one-time fee that only applies when your car actually sells through a buyer who found it on PrimeDrive. If it doesn't sell, you never pay commission.</p></div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">Can I switch between Individual and Dealership plans?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>Yes. If your business grows from personal selling to a dealership, you can upgrade to a Dealer plan at any time. Contact us and we'll handle the transition and pro-rate your billing.</p></div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">What does "featured placement" mean?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>Featured listings appear at the top of search results and on the homepage, giving your cars significantly more visibility. Standard and Premium individual plans include this, along with all Dealer plans.</p></div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">How does the "Verified" badge work?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>Verified Seller and Verified Dealership badges appear on your listings to build buyer trust. Once your identity and business are confirmed, the badge is displayed on every listing you post. Available from the Standard plan and above.</p></div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">What payment methods do you accept?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>We accept Orange Money, MyZaka, and direct bank transfers. After choosing your plan, you'll receive payment instructions in the app. Your subscription activates as soon as payment is confirmed.</p></div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-item__q">Can I cancel my subscription?<i class="bi bi-chevron-down"></i></div>
                        <div class="faq-item__a"><p>Absolutely. You can cancel or downgrade anytime by contacting us. There are no cancellation fees or long-term contracts. Your current plan stays active until the end of the billing period.</p></div>
                    </div>
                </div>

                <!-- Trust signals -->
                <div class="paywall__guarantee">
                    <div class="paywall__guarantee-item"><i class="bi bi-shield-check"></i> Secure mobile money payments</div>
                    <div class="paywall__guarantee-item"><i class="bi bi-arrow-repeat"></i> Cancel or downgrade anytime</div>
                    <div class="paywall__guarantee-item"><i class="bi bi-headset"></i> Customer support included</div>
                </div>

                <!-- Payment methods -->
                <div style="text-align: center; margin-top: 32px;">
                    <p class="body-sm" style="margin-bottom: 8px;">Accepted payment methods:</p>
                    <div class="pay-methods" id="payMethods">
                        <div class="pay-method active" data-method="orange_money" onclick="selectPayMethod(this)">
                            <i class="bi bi-phone"></i> Orange Money
                        </div>
                        <div class="pay-method" data-method="myzaka" onclick="selectPayMethod(this)">
                            <i class="bi bi-phone"></i> MyZaka
                        </div>
                        <div class="pay-method" data-method="manual" onclick="selectPayMethod(this)">
                            <i class="bi bi-chat-dots"></i> Mobile Money
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Admin Section (hidden unless admin) -->
        <section class="admin" id="adminSection" style="display: none;">
            <div class="container">
                <div class="admin__header">
                    <div>
                        <div class="label" style="margin-bottom: 8px;"><i class="bi bi-shield-lock-fill"></i> Admin Panel</div>
                        <h2 class="heading-lg">Payment Management</h2>
                    </div>
                    <button class="btn btn--secondary btn--sm" onclick="loadAdminData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>

                <div class="admin__stats" id="adminStats">
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Pending Payments</div>
                        <div class="admin__stat-value" id="statPending">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Awaiting Verification</div>
                        <div class="admin__stat-value" id="statAwaiting">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Completed Today</div>
                        <div class="admin__stat-value" id="statCompleted">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Revenue (Pula)</div>
                        <div class="admin__stat-value" id="statRevenue">P0</div>
                    </div>
                </div>

                <!-- Pending payments table -->
                <div class="admin__section">
                    <div class="admin__section-header">
                        <div class="admin__section-title">Pending & Awaiting Payments</div>
                    </div>
                    <div id="pendingTableWrap">
                        <table class="admin__table">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>User</th>
                                    <th>Tier</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                <tr><td colspan="8" class="admin__no-data">No pending payments</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent transactions -->
                <div class="admin__section">
                    <div class="admin__section-header">
                        <div class="admin__section-title">Recent Subscription Transactions</div>
                    </div>
                    <div id="recentTableWrap">
                        <table class="admin__table">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Tier</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentTableBody">
                                <tr><td colspan="6" class="admin__no-data">No transactions yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SALE TRANSACTIONS (car purchases) -->
                <div class="admin__section" style="margin-top:48px;">
                    <div class="admin__section-header">
                        <div class="admin__section-title"><i class="bi bi-bag-check"></i> Car Sale Transactions</div>
                    </div>
                    <div class="admin__stats" id="saleStats" style="margin-bottom:24px;">
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Pending Confirmation</div>
                            <div class="admin__stat-value" id="statSalePending">0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Released</div>
                            <div class="admin__stat-value" id="statSaleReleased">0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Commission Earned</div>
                            <div class="admin__stat-value" id="statCommission">P0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Total GMV</div>
                            <div class="admin__stat-value" id="statGMV">P0</div>
                        </div>
                    </div>
                    <table class="admin__table">
                        <thead>
                            <tr>
                                <th>Ref</th>
                                <th>Car</th>
                                <th>Buyer</th>
                                <th>Amount</th>
                                <th>Commission</th>
                                <th>Seller Net</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="saleTransTableBody">
                            <tr><td colspan="9" class="admin__no-data">No car sales yet</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- SOURCING REQUESTS -->
                <div class="admin__section" style="margin-top:48px;">
                    <div class="admin__section-header">
                        <div class="admin__section-title"><i class="bi bi-search-heart"></i> Sourcing Requests</div>
                    </div>
                    <table class="admin__table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Model</th>
                                <th>Year</th>
                                <th>Budget</th>
                                <th>Notes</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sourcingTableBody">
                            <tr><td colspan="9" class="admin__no-data">No sourcing requests</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- DISPUTES -->
                <div class="admin__section" style="margin-top:48px;">
                    <div class="admin__section-header">
                        <div class="admin__section-title"><i class="bi bi-flag"></i> Disputes</div>
                    </div>
                    <table class="admin__table">
                        <thead>
                            <tr>
                                <th>Ref</th>
                                <th>Vehicle</th>
                                <th>Filed By</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disputesTableBody">
                            <tr><td colspan="7" class="admin__no-data">No disputes</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </section>
    </div>

    <!-- ============================= -->
    <!-- PAGE: LISTING DETAIL          -->
    <!-- ============================= -->
    <div class="page" id="page-listing">
        <section class="listing-detail">
            <div class="container">
                <button class="btn btn--ghost btn--sm" onclick="navigate('buy')" style="margin-bottom: 20px;">
                    <i class="bi bi-arrow-left"></i> Back to Marketplace
                </button>
                <div id="listingDetailContent">
                    <div style="text-align:center; padding:60px 0; color:var(--text-tertiary);">
                        <i class="bi bi-arrow-repeat spin" style="font-size:2rem;"></i>
                        <p style="margin-top:12px;">Loading listing...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: DEALER DASHBOARD        -->
    <!-- ============================= -->
    <div class="page" id="page-mylistings">
        <section class="listings">
            <div class="container">
                <div class="listings__header">
                    <div class="listings__header-text">
                        <div class="label"><i class="bi bi-speedometer2"></i> My Listings &amp; Leads</div>
                        <h1 class="heading-lg">Seller Dashboard</h1>
                        <div class="listings__count" id="myListingsCount">Loading...</div>
                    </div>
                    <button class="btn btn--primary btn--sm" onclick="navigate('sell')">
                        <i class="bi bi-plus-circle"></i> New Listing
                    </button>
                </div>

                <!-- Stats row -->
                <div class="admin__stats" id="sellerStats" style="margin-bottom: 32px;">
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Active Listings</div>
                        <div class="admin__stat-value" id="statMyListings">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Total Views</div>
                        <div class="admin__stat-value" id="statMyViews">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Inquiries</div>
                        <div class="admin__stat-value" id="statMyClicks">0</div>
                    </div>
                    <div class="admin__stat-card">
                        <div class="admin__stat-label">Total Leads</div>
                        <div class="admin__stat-value" id="statMyLeads">0</div>
                    </div>
                </div>

                <!-- Earnings Section -->
                <div class="admin__section" style="margin-bottom:32px;" id="sellerEarningsSection">
                    <div class="admin__section-header">
                        <div class="admin__section-title"><i class="bi bi-wallet2"></i> Earnings &amp; Payouts</div>
                    </div>
                    <div class="admin__stats" style="margin-bottom:16px;">
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Total Sales</div>
                            <div class="admin__stat-value" id="statSellerSales">0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Gross Revenue</div>
                            <div class="admin__stat-value" id="statSellerGross">P0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Commission Paid</div>
                            <div class="admin__stat-value" id="statSellerCommission">P0</div>
                        </div>
                        <div class="admin__stat-card">
                            <div class="admin__stat-label">Net Received</div>
                            <div class="admin__stat-value" id="statSellerNet">P0</div>
                        </div>
                    </div>
                    <table class="admin__table" id="sellerPayoutsTable">
                        <thead>
                            <tr>
                                <th>Ref</th>
                                <th>Vehicle</th>
                                <th>Sale Price</th>
                                <th>Commission</th>
                                <th>Your Payout</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="sellerPayoutsBody">
                            <tr><td colspan="8" class="admin__no-data">No sales yet — your earnings will appear here</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- My listings grid -->
                <div class="car-grid" id="myListingsGrid"></div>

                <!-- Leads table -->
                <div style="margin-top: 48px;">
                    <h2 class="heading-md" style="margin-bottom: 16px;">Lead History</h2>
                    <div class="admin__table-wrap">
                        <table class="admin__table">
                            <thead>
                                <tr>
                                    <th>Lead Code</th>
                                    <th>Listing</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="myLeadsTableBody">
                                <tr><td colspan="5" class="admin__no-data">No leads yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: MESSAGES                -->
    <!-- ============================= -->
    <div class="page" id="page-messages">
        <section class="listings">
            <div class="container">
                <div class="listings__header">
                    <div class="listings__header-text">
                        <div class="label"><i class="bi bi-chat-dots"></i> Messages</div>
                        <h1 class="heading-lg">Inbox</h1>
                        <div class="listings__count" id="msgCount">Loading...</div>
                    </div>
                </div>

                <div class="msg-layout">
                    <!-- Conversation List -->
                    <div class="msg-list" id="msgConvList">
                        <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
                            <i class="bi bi-arrow-repeat spin" style="font-size:1.5rem;"></i>
                        </div>
                    </div>

                    <!-- Chat Panel -->
                    <div class="msg-chat" id="msgChatPanel">
                        <div class="msg-chat__empty">
                            <i class="bi bi-chat-dots" style="font-size:2.5rem;color:var(--text-tertiary);"></i>
                            <p style="margin-top:12px;color:var(--text-tertiary);">Select a conversation to start messaging</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- ============================= -->
    <!-- PAGE: CHECKOUT                -->
    <!-- ============================= -->
    <div class="page" id="page-checkout">
        <section class="listings">
            <div class="container" style="max-width:640px;">
                <div class="listings__header">
                    <div class="listings__header-text">
                        <div class="label"><i class="bi bi-bag-check"></i> Checkout</div>
                        <h1 class="heading-lg">Complete Purchase</h1>
                    </div>
                </div>

                <div id="checkoutContent">
                    <div style="text-align:center;padding:40px;color:var(--text-tertiary);">
                        <i class="bi bi-arrow-repeat spin" style="font-size:1.5rem;"></i>
                    </div>
                </div>
            </div>
        </section>
    </div>


    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <div class="pwa-install-banner__icon">P<span style="display:inline-block;width:5px;height:5px;background:#22c55e;border-radius:50%;margin-left:1px;margin-bottom:6px;"></span></div>
        <div class="pwa-install-banner__text">
            <div class="pwa-install-banner__title">Install PrimeDrive</div>
            <div class="pwa-install-banner__desc">Add to home screen for the best experience</div>
        </div>
        <div class="pwa-install-banner__actions">
            <button class="btn btn--primary btn--sm" id="pwaInstallBtn" onclick="installPWA()">
                <i class="bi bi-download"></i> Install
            </button>
            <div class="pwa-install-banner__close" onclick="dismissInstallBanner()">
                <i class="bi bi-x-lg"></i>
            </div>
        </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer class="footer">
        <div class="container footer__inner">
            <div class="footer__logo">
                PrimeDrive<span class="nav__logo-dot"></span>
            </div>
            <ul class="footer__links">
                <li><a class="footer__link" onclick="navigate('home')">Home</a></li>
                <li><a class="footer__link" onclick="navigate('buy')">Buy</a></li>
                <li><a class="footer__link" onclick="navigate('rent')">Rent</a></li>
                <li><a class="footer__link" onclick="navigate('sell')">Sell</a></li>
                <li><a class="footer__link" onclick="navigate('about')">About</a></li>
                <li><a class="footer__link" onclick="navigate('contact')">Contact</a></li>
            </ul>
            <div class="footer__copy">&copy; 2026 PrimeDrive Botswana. All rights reserved.</div>
        </div>
    </footer>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Receipt Modal -->
    <div class="receipt-overlay" id="receiptOverlay" onclick="if(event.target===this)closeReceipt()">
        <div class="receipt-card" id="receiptCard"></div>
    </div>

    <!-- Support Float -->
    <div class="wa-float">
        <a href="https://wa.me/26777625997" target="_blank" class="wa-float__btn" title="PrimeDrive Support">
            <i class="bi bi-headset"></i>
        </a>
    </div>


    <!-- ========================================
         JAVASCRIPT
         ======================================== -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    /* ===========================================
       DATA — EDIT LISTINGS HERE
       =========================================== */
    // Global error handler — prevents one error from killing the whole app
    window.addEventListener('error', function(e) {
        console.error('[PrimeDrive] Error:', e.message, e.filename, e.lineno);
    });
    window.addEventListener('unhandledrejection', function(e) {
        console.warn('[PrimeDrive] Async error:', e.reason);
        e.preventDefault(); // Don't crash
    });

    const WHATSAPP = "26777625997";

    // ===========================================
    // SUPABASE CLIENT (single init, no guards)
    // ===========================================
    const supabase = window.supabaseClient || window.supabase.createClient(
        'https://lbzaenivqbxjalhgrppw.supabase.co',
        'sb_publishable_L23K_alF_v5syG9saBe0pQ_Lv2HyIJw'  // Click copy icon in Supabase API Keys to verify this is complete
    );
    window.supabaseClient = supabase;

    // Boot: restore session + load data + auth listener
    (async function boot() {
        try { await restoreSession(); } catch(e) { console.warn('Session restore:', e); }
        try { loadFeaturedListings(); } catch(e) {}
        try { loadMarketplaceListings(); } catch(e) {}
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session && !currentUser) {
                currentUser = session.user;
                await loadProfile();
                onLoginSuccess();
                hideLogin();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentProfile = null;
                isAdmin = false;
            }
        });
    })();

    // Auth state
    let currentUser = null;   // Supabase auth user
    let currentProfile = null; // profiles table row
    let selectedPayMethod = 'orange_money';
    let isAdmin = false;

    // Tier config
    const TIER_CONFIG = {
        free:           { price: 0,    limit: 1,    label: 'Free' },
        basic:          { price: 25,   limit: 3,    label: 'Basic' },
        standard:       { price: 60,   limit: 10,   label: 'Standard' },
        premium:        { price: 100,  limit: null, label: 'Premium' },
        dealer_starter: { price: 750,  limit: 20,   label: 'Dealer Starter' },
        dealer_pro:     { price: 1500, limit: 60,   label: 'Dealer Pro' },
        dealer_elite:   { price: 2500, limit: null, label: 'Dealer Elite' },
    };

    // Car images from Unsplash (free to use)
    const carImages = {
        hilux:      "https://images.unsplash.com/photo-1625231334401-4abc27174831?w=480&q=75",
        bmw3:       "https://images.unsplash.com/photo-1555215695-3004980ad54e?w=480&q=75",
        mercedesC:  "https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?w=480&q=75",
        ranger:     "https://images.unsplash.com/photo-1612825173281-9a193378527e?w=480&q=75",
        polo:       "https://images.unsplash.com/photo-1606611013016-969c19ba523c?w=480&q=75",
        tucson:     "https://images.unsplash.com/photo-1633695410777-d06cd4638edf?w=480&q=75",
        fortuner:   "https://images.unsplash.com/photo-1519641471654-76ce0107ad1b?w=480&q=75",
        np200:      "https://images.unsplash.com/photo-1544636331-e26879cd4d9b?w=480&q=75",
        fit:        "https://images.unsplash.com/photo-1609521263047-f8f205293f24?w=480&q=75",
        corolla:    "https://images.unsplash.com/photo-1623869675781-80aa31012a5a?w=480&q=75",
        xtrail:     "https://images.unsplash.com/photo-1549317661-bd32c8ce0afe?w=480&q=75",
        swift:      "https://images.unsplash.com/photo-1541899481282-d53bffe3c35d?w=480&q=75",
        rental1:    "https://images.unsplash.com/photo-1590362891991-f776e747a588?w=480&q=75",
        rental2:    "https://images.unsplash.com/photo-1552519507-da3b142c6e3d?w=480&q=75",
        rental3:    "https://images.unsplash.com/photo-1494976388531-d1058494cdd8?w=480&q=75",
        rental4:    "https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=480&q=75",
        rental5:    "https://images.unsplash.com/photo-1502877338535-766e1452684a?w=480&q=75",
        rental6:    "https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=480&q=75",
    };

    let marketplaceListings = []; // Loaded from Supabase
    let currentListingDetail = null; // Currently viewed listing

    const rentalListings = [
        // Rental vehicles loaded separately
    ];


    /* ===========================================
       NAVIGATION
       =========================================== */
    function navigate(page) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        var el = document.getElementById('page-' + page);
        if (!el) { page = 'home'; el = document.getElementById('page-home'); }
        el.classList.add('active');

        // Update nav active states
        document.querySelectorAll('[data-nav]').forEach(el => {
            el.classList.toggle('active', el.dataset.nav === page);
        });

        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Load data for specific pages
        if (page === 'home') loadFeaturedListings();
        if (page === 'buy') loadMarketplaceListings();
        if (page === 'mylistings') loadMyListings();
        if (page === 'messages') loadConversations();
        if (page === 'dashboard') loadBuyerPurchases();
        if (page === 'sell' && !currentUser) { showLogin(); return; }

        // Re-init scroll reveals
        requestAnimationFrame(initRevealObserver);
    }

    function toggleMobileNav() {
        const hamburger = document.getElementById('hamburger');
        const mobileNav = document.getElementById('mobileNav');
        hamburger.classList.toggle('active');
        mobileNav.classList.toggle('active');
        document.body.style.overflow = mobileNav.classList.contains('active') ? 'hidden' : '';
    }

    // Scroll listener for nav
    window.addEventListener('scroll', () => {
        document.getElementById('navbar').classList.toggle('scrolled', window.scrollY > 10);
    });


    /* ===========================================
       THEME
       =========================================== */
    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.getAttribute('data-theme') === 'dark';
        html.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('themeIcon').className = isDark ? 'bi bi-moon' : 'bi bi-sun';
        localStorage.setItem('pd-theme', isDark ? 'light' : 'dark');
    }

    function loadTheme() {
        const saved = localStorage.getItem('pd-theme');
        if (saved === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').className = 'bi bi-sun';
        }
    }


    /* ===========================================
       RENDERING HELPERS
       =========================================== */
    function formatPrice(p) {
        return 'P ' + p.toLocaleString('en-BW');
    }

    function buildSaleCard(car) {
        // car can be a Supabase listing object or legacy format
        const id = car.id || '';
        const make = car.make || car.brand || '';
        const model = car.model || '';
        const year = car.year || '';
        const price = car.price || 0;
        const mileage = car.mileage || 0;
        const transmission = car.transmission || '';
        const condition = car.condition || '';
        const location = car.location || '';
        const status = car.status || 'unverified';
        const sellerType = car.seller_type || 'individual';
        const mainPhoto = car.main_photo || car.image || '';
        // Seller profile info (from joined query)
        const sellerProfile = car.profiles || null;
        const sellerName = sellerProfile ? (sellerProfile.full_name || sellerProfile.email || 'Seller') : '';
        const sellerInitial = sellerName ? sellerName.charAt(0).toUpperCase() : 'S';
        const statusBadge = status === 'verified'
            ? '<div class="car-card__badge car-card__badge--accent"><i class="bi bi-patch-check-fill"></i> Verified</div>'
            : '<div class="car-card__badge" style="background:rgba(245,158,11,0.85);"><i class="bi bi-clock"></i> Unverified</div>';
        const sellerBadge = sellerType === 'dealer'
            ? '<span class="car-card__spec"><i class="bi bi-building"></i> Dealership</span>'
            : '<span class="car-card__spec"><i class="bi bi-person"></i> Individual</span>';
        const imgHTML = mainPhoto
            ? `<img src="${mainPhoto}" alt="${make} ${model}" loading="lazy">`
            : `<div style="height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);"><i class="bi bi-car-front" style="font-size:3rem;color:var(--text-tertiary);"></i></div>`;

        // Seller footer
        const sellerHTML = sellerName ? `
            <div class="car-card__seller">
                <div class="car-card__seller-avatar">${sellerInitial}</div>
                <div>
                    <div class="car-card__seller-name">${sellerName}</div>
                    <div class="car-card__seller-role">${sellerType === 'dealer' ? 'Dealership' : 'Private Seller'}</div>
                </div>
            </div>` : '';

        return `
        <div class="car-card reveal" onclick="openListingDetail('${id}')" style="cursor:pointer;">
            <div class="car-card__image">
                ${imgHTML}
                ${statusBadge}
                <div class="car-card__type-badge car-card__type-badge--sale">For Sale</div>
            </div>
            <div class="car-card__body">
                <div class="car-card__name">${make} ${model} ${year}</div>
                <div class="car-card__specs">
                    <span class="car-card__spec"><i class="bi bi-calendar3"></i> ${year}</span>
                    ${mileage ? `<span class="car-card__spec"><i class="bi bi-speedometer2"></i> ${Number(mileage).toLocaleString()} km</span>` : ''}
                    ${transmission ? `<span class="car-card__spec"><i class="bi bi-gear"></i> ${transmission}</span>` : ''}
                    ${sellerBadge}
                </div>
                <div class="car-card__divider"></div>
                <div class="car-card__footer">
                    <div>
                        <div class="car-card__price">${formatPrice(Number(price))}</div>
                    </div>
                    <div class="car-card__location"><i class="bi bi-geo-alt"></i> ${location}</div>
                </div>
            </div>
            ${sellerHTML}
        </div>`;
    }

    function buildRentalCard(car) {
        return `
        <div class="car-card reveal">
            <div class="car-card__image">
                <img src="${car.image}" alt="${car.brand} ${car.model}" loading="lazy">
                ${car.badge ? `<div class="car-card__badge car-card__badge--accent"><i class="bi bi-star-fill"></i> ${car.badge}</div>` : ''}
                <div class="car-card__type-badge car-card__type-badge--rent">For Rent</div>
            </div>
            <div class="car-card__body">
                <div class="car-card__name">${car.brand} ${car.model}</div>
                <div class="car-card__specs">
                    <span class="car-card__spec"><i class="bi bi-calendar3"></i> ${car.year}</span>
                    <span class="car-card__spec"><i class="bi bi-people"></i> ${car.seats} seats</span>
                    <span class="car-card__spec"><i class="bi bi-gear"></i> ${car.transmission}</span>
                </div>
                <div class="car-card__divider"></div>
                <div class="car-card__footer">
                    <div>
                        <div class="car-card__price">${formatPrice(car.dailyRate)} <span class="car-card__price-sub">/ day</span></div>
                    </div>
                    <div class="car-card__location"><i class="bi bi-geo-alt"></i> ${car.location}</div>
                </div>
            </div>
            <div class="car-card__cta">
                <button onclick="navigate('contact')" class="btn btn--primary btn--sm btn--full">
                    <i class="bi bi-calendar-check"></i> Enquire
                </button>
            </div>
        </div>`;
    }

    function noResultsHTML() {
        return `<div class="no-results">
            <div class="no-results__icon"><i class="bi bi-car-front"></i></div>
            <div class="no-results__title">No listings found</div>
            <p class="body-sm">Try adjusting your filters, or list your own car for sale.</p>
            <div style="margin-top:20px;">
                <button class="btn btn--primary" onclick="navigate('sell')">
                    <i class="bi bi-plus-circle"></i> Create a Listing
                </button>
            </div>
        </div>`;
    }


    /* ===========================================
       BUY SECTION
       =========================================== */
    // Hardcoded filter options for Botswana market
    const botswanaBrands = [
        'BMW', 'Chery', 'Ford', 'Honda', 'Hyundai', 'Isuzu', 'Kia',
        'Mazda', 'Mercedes-Benz', 'Mitsubishi', 'Nissan', 'Suzuki',
        'Toyota', 'Volkswagen'
    ];
    const bwYears = [];
    for (let y = 2026; y >= 2000; y--) bwYears.push(y);
    const bwLocations = ['Gaborone'];

    function populateBuyFilters() {
        // Use hardcoded options, but add any extras from actual listings too
        const brands = [...new Set([...botswanaBrands, ...marketplaceListings.map(c => c.make)])].sort();
        const years = [...new Set([...bwYears, ...marketplaceListings.map(c => c.year)])].sort((a, b) => b - a);
        const locations = [...new Set([...bwLocations, ...marketplaceListings.map(c => c.location)])].sort();

        appendOptions('buyFilterBrand', brands);
        appendOptions('buyFilterYear', years);
        appendOptions('buyFilterLocation', locations);
    }

    function renderBuyCars(cars) {
        const grid = document.getElementById('buyGrid');
        document.getElementById('buyCount').textContent = `Showing ${cars.length} car${cars.length !== 1 ? 's' : ''}`;
        grid.innerHTML = cars.length ? cars.map(buildSaleCard).join('') : noResultsHTML();
        initRevealObserver();
    }

    function applyBuyFilters() {
        let filtered = [...marketplaceListings];
        const brand = val('buyFilterBrand');
        const price = val('buyFilterPrice');
        const year = val('buyFilterYear');
        const trans = val('buyFilterTrans');
        const loc = val('buyFilterLocation');

        if (brand) filtered = filtered.filter(c => c.make === brand);
        if (year) filtered = filtered.filter(c => c.year == year);
        if (trans) filtered = filtered.filter(c => c.transmission === trans);
        if (loc) filtered = filtered.filter(c => c.location === loc);
        if (price) {
            const [min, max] = price.split('-').map(Number);
            filtered = filtered.filter(c => c.price >= min && c.price <= max);
        }
        renderBuyCars(filtered);
    }

    function resetBuyFilters() {
        ['buyFilterBrand','buyFilterPrice','buyFilterYear','buyFilterTrans','buyFilterLocation'].forEach(id => {
            document.getElementById(id).value = '';
        });
        renderBuyCars(marketplaceListings);
    }


    /* ===========================================
       RENT SECTION
       =========================================== */
    function populateRentFilters() {
        // Use hardcoded options, but add any extras from actual listings too
        const brands = [...new Set([...botswanaBrands, ...rentalListings.map(c => c.brand)])].sort();
        const years = [...new Set([...bwYears, ...rentalListings.map(c => c.year)])].sort((a, b) => b - a);
        const locations = [...new Set([...bwLocations, ...rentalListings.map(c => c.location)])].sort();

        appendOptions('rentFilterBrand', brands);
        appendOptions('rentFilterYear', years);
        appendOptions('rentFilterLocation', locations);
    }

    function renderRentCars(cars) {
        const grid = document.getElementById('rentGrid');
        document.getElementById('rentCount').textContent = `Showing ${cars.length} car${cars.length !== 1 ? 's' : ''}`;
        grid.innerHTML = cars.length ? cars.map(buildRentalCard).join('') : noResultsHTML();
        initRevealObserver();
    }

    function applyRentFilters() {
        let filtered = [...rentalListings];
        const brand = val('rentFilterBrand');
        const price = val('rentFilterPrice');
        const year = val('rentFilterYear');
        const trans = val('rentFilterTrans');
        const loc = val('rentFilterLocation');

        if (brand) filtered = filtered.filter(c => c.brand === brand);
        if (year) filtered = filtered.filter(c => c.year == year);
        if (trans) filtered = filtered.filter(c => c.transmission === trans);
        if (loc) filtered = filtered.filter(c => c.location === loc);
        if (price) {
            const [min, max] = price.split('-').map(Number);
            filtered = filtered.filter(c => c.dailyRate >= min && c.dailyRate <= max);
        }
        renderRentCars(filtered);
    }

    function resetRentFilters() {
        ['rentFilterBrand','rentFilterPrice','rentFilterYear','rentFilterTrans','rentFilterLocation'].forEach(id => {
            document.getElementById(id).value = '';
        });
        renderRentCars(rentalListings);
    }


    /* ===========================================
       SELL FORM — saves to Supabase
       =========================================== */
    let uploadedPhotos = []; // { file: File, data: base64 }

    function handlePhotos(e) {
        const files = Array.from(e.target.files).slice(0, 10 - uploadedPhotos.length);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = ev => {
                uploadedPhotos.push({ file, data: ev.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        e.target.value = '';
    }

    function renderPreviews() {
        document.getElementById('photoPreviews').innerHTML = uploadedPhotos.map((p, i) => `
            <div class="upload-preview">
                <img src="${p.data}" alt="Photo ${i + 1}">
                <div class="upload-preview__remove" onclick="removePhoto(${i})"><i class="bi bi-x"></i></div>
            </div>
        `).join('');
    }

    function removePhoto(i) {
        uploadedPhotos.splice(i, 1);
        renderPreviews();
    }

    async function submitSellForm(e) {
        e.preventDefault();

        if (!currentUser) { showLogin(); return; }

        const btn = document.getElementById('sellSubmitBtn');
        const origHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Publishing...';

        const make = val('sellBrand');
        const model = val('sellModel');
        const title = make + ' ' + model;

        try {
            // 1. Insert listing record
            const { data: listing, error: listErr } = await supabase
                .from('listings')
                .insert({
                    user_id: currentUser.id,
                    seller_type: (currentProfile && currentProfile.role === 'dealer') ? 'dealer' : 'individual',
                    title,
                    make,
                    model,
                    year: parseInt(val('sellYear')),
                    mileage: parseInt(val('sellMileage')) || null,
                    transmission: val('sellTransmission'),
                    condition: val('sellCondition'),
                    price: parseFloat(val('sellPrice')),
                    location: val('sellLocation'),
                    description: val('sellNotes') || null,
                    status: 'unverified',
                })
                .select()
                .single();

            if (listErr) throw listErr;

            // 2. Upload photos to Supabase Storage
            for (let i = 0; i < uploadedPhotos.length; i++) {
                const photo = uploadedPhotos[i];
                const ext = photo.file.name.split('.').pop().toLowerCase();
                const path = `${currentUser.id}/${listing.id}/${i}.${ext}`;

                const { error: upErr } = await supabase.storage
                    .from('listing-photos')
                    .upload(path, photo.file, { cacheControl: '3600', upsert: true });

                if (upErr) { console.warn('Photo upload error:', upErr.message); continue; }

                // Get public URL
                const { data: urlData } = supabase.storage.from('listing-photos').getPublicUrl(path);
                const photoUrl = urlData.publicUrl;

                // Insert photo record
                await supabase.from('listing_photos').insert({
                    listing_id: listing.id,
                    photo_url: photoUrl,
                    display_order: i,
                });
            }

            // 3. Update user listing count
            if (currentProfile) {
                await supabase.from('profiles').update({
                    listing_count: (currentProfile.listing_count || 0) + 1,
                }).eq('id', currentUser.id);
                currentProfile.listing_count = (currentProfile.listing_count || 0) + 1;
                updateTierDisplay();
            }

            // 4. Success
            alert('Your listing has been published on PrimeDrive!');
            document.getElementById('sellForm').reset();
            uploadedPhotos = [];
            renderPreviews();
            navigate('buy'); // Go to marketplace to see it

        } catch (err) {
            console.error('Listing error:', err);
            alert('Error creating listing: ' + (err.message || 'Please try again'));
        } finally {
            btn.disabled = false;
            btn.innerHTML = origHTML;
        }
    }


    /* ===========================================
       MARKETPLACE — Load from Supabase
       =========================================== */
    async function loadMarketplaceListings() {
        const grid = document.getElementById('buyGrid');
        const countEl = document.getElementById('buyCount');
        countEl.textContent = 'Loading listings...';
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-tertiary);"><i class="bi bi-arrow-repeat spin" style="font-size:2rem;"></i></div>';

        try {
            // Fetch listings with first photo and seller info
            const { data: listings, error } = await supabase
                .from('listings')
                .select('*, listing_photos(photo_url, display_order), profiles(full_name, email, role)')
                .in('status', ['unverified', 'verified'])
                .order('created_at', { ascending: false });

            if (error) throw error;

            // Attach main_photo to each listing
            marketplaceListings = (listings || []).map(l => {
                const photos = l.listing_photos || [];
                photos.sort((a, b) => a.display_order - b.display_order);
                l.main_photo = photos.length ? photos[0].photo_url : '';
                return l;
            });

            renderBuyCars(marketplaceListings);

            // Repopulate filters with actual data
            const brandSelect = document.getElementById('buyFilterBrand');
            if (brandSelect) {
                const makes = [...new Set(marketplaceListings.map(l => l.make))].filter(Boolean).sort();
                brandSelect.innerHTML = '<option value="">All Brands</option>';
                makes.forEach(m => { brandSelect.innerHTML += `<option value="${m}">${m}</option>`; });
            }
            const locSelect = document.getElementById('buyFilterLocation');
            if (locSelect) {
                const locs = [...new Set(marketplaceListings.map(l => l.location))].filter(Boolean).sort();
                locSelect.innerHTML = '<option value="">All Locations</option>';
                locs.forEach(l => { locSelect.innerHTML += `<option value="${l}">${l}</option>`; });
            }

        } catch (err) {
            console.error('Marketplace load error:', err);
            grid.innerHTML = noResultsHTML();
            countEl.textContent = 'Error loading listings';
        }
    }


    /* ===========================================
       FEATURED LISTINGS (HOME PAGE)
       =========================================== */
    let featuredLoaded = false;

    async function loadFeaturedListings() {
        const grid = document.getElementById('featuredGrid');
        if (!grid) return;
        // Only show loading spinner on first load
        if (!featuredLoaded) {
            grid.innerHTML = '<div style="text-align:center;padding:48px 0;color:var(--text-tertiary);grid-column:1/-1;"><i class="bi bi-arrow-repeat spin" style="font-size:1.5rem;"></i><p style="margin-top:8px;">Loading listings...</p></div>';
        }

        try {
            // Fetch latest 6 listings, prioritize verified
            const { data: listings, error } = await supabase
                .from('listings')
                .select('*, listing_photos(photo_url, display_order), profiles(full_name, email, role)')
                .in('status', ['unverified', 'verified'])
                .order('status', { ascending: true }) // verified first
                .order('created_at', { ascending: false })
                .limit(6);

            if (error) throw error;

            if (!listings || listings.length === 0) {
                grid.innerHTML = `<div class="featured-listings__empty">
                    <i class="bi bi-car-front"></i>
                    <p>No listings yet. Be the first to list your car on PrimeDrive!</p>
                    <button class="btn btn--primary btn--sm" onclick="navigate('sell')" style="margin-top:12px;">
                        <i class="bi bi-plus-circle"></i> Create a Listing
                    </button>
                </div>`;
                return;
            }

            // Process listings
            const featured = listings.map(l => {
                const photos = l.listing_photos || [];
                photos.sort((a, b) => a.display_order - b.display_order);
                l.main_photo = photos.length ? photos[0].photo_url : '';
                return l;
            });

            grid.innerHTML = featured.map(buildSaleCard).join('');
            featuredLoaded = true;
            initRevealObserver();

        } catch (err) {
            console.error('Featured listings error:', err);
            grid.innerHTML = `<div class="featured-listings__empty">
                <i class="bi bi-exclamation-triangle"></i>
                <p>Could not load listings. Pull down to refresh.</p>
            </div>`;
        }
    }


    /* ===========================================
       LISTING DETAIL PAGE
       =========================================== */
    async function openListingDetail(id) {
        if (!id) return;
        navigate('listing');

        const container = document.getElementById('listingDetailContent');
        container.innerHTML = '<div style="text-align:center;padding:60px 0;color:var(--text-tertiary);"><i class="bi bi-arrow-repeat spin" style="font-size:2rem;"></i><p style="margin-top:12px;">Loading listing...</p></div>';

        try {
            let listing, photos;

                // Fetch listing
                const { data, error } = await supabase
                    .from('listings')
                    .select('*, listing_photos(id, photo_url, display_order), profiles(full_name, email, role)')
                    .eq('id', id)
                    .single();
                if (error) throw error;
                listing = data;
                photos = (data.listing_photos || []).sort((a, b) => a.display_order - b.display_order);

                // Increment view count
                supabase.rpc('increment_listing_views', { listing_uuid: id }).catch(() => {});

            currentListingDetail = listing;

            // Build gallery
            let galleryHTML = '';
            if (photos.length > 0) {
                const mainImg = photos[0].photo_url;
                galleryHTML = `<div id="mainPhotoWrap" style="margin-bottom:12px;border-radius:var(--radius-xl);overflow:hidden;max-height:420px;">
                    <img id="mainPhoto" src="${mainImg}" alt="${listing.title}" style="width:100%;height:420px;object-fit:cover;">
                </div>`;
                if (photos.length > 1) {
                    galleryHTML += `<div class="listing-detail__thumbs">`;
                    photos.forEach((p, i) => {
                        galleryHTML += `<div class="listing-detail__thumb ${i===0?'active':''}" onclick="switchPhoto('${p.photo_url}', this)">
                            <img src="${p.photo_url}" alt="Photo ${i+1}">
                        </div>`;
                    });
                    galleryHTML += `</div>`;
                }
            } else {
                galleryHTML = `<div style="height:250px;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);border-radius:var(--radius-xl);margin-bottom:24px;">
                    <i class="bi bi-car-front" style="font-size:4rem;color:var(--text-tertiary);"></i>
                </div>`;
            }

            // Badges
            const statusBadge = listing.status === 'verified'
                ? '<span class="listing-detail__badge listing-detail__badge--verified"><i class="bi bi-patch-check-fill"></i> Verified</span>'
                : '<span class="listing-detail__badge listing-detail__badge--unverified"><i class="bi bi-clock"></i> Unverified</span>';
            const sellerBadge = listing.seller_type === 'dealer'
                ? '<span class="listing-detail__badge listing-detail__badge--dealer"><i class="bi bi-building"></i> Dealership</span>'
                : '<span class="listing-detail__badge listing-detail__badge--individual"><i class="bi bi-person"></i> Individual Seller</span>';

            // Deposit calculation
            const price = Number(listing.price);
            let deposit = 500;
            if (price >= 200000) deposit = 2000;
            else if (price >= 100000) deposit = 1000;
            const commission = price < 100000 ? '5%' : '6.5%';

            // Seller profile info
            const detailSellerProfile = listing.profiles || null;
            const detailSellerName = detailSellerProfile ? (detailSellerProfile.full_name || detailSellerProfile.email || 'Seller') : 'Seller';
            const detailSellerInitial = detailSellerName.charAt(0).toUpperCase();

            container.innerHTML = `
                ${galleryHTML}
                <div class="listing-detail__content">
                    <div class="listing-detail__info">
                        <div class="listing-detail__badges">${statusBadge}${sellerBadge}</div>
                        <h1 class="listing-detail__title">${listing.title || listing.make + ' ' + listing.model} ${listing.year}</h1>
                        <div class="listing-detail__price">${formatPrice(price)}</div>

                        <div class="listing-detail__specs">
                            <div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Year</div>
                                <div class="listing-detail__spec-value">${listing.year}</div>
                            </div>
                            ${listing.mileage ? `<div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Mileage</div>
                                <div class="listing-detail__spec-value">${Number(listing.mileage).toLocaleString()} km</div>
                            </div>` : ''}
                            ${listing.transmission ? `<div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Transmission</div>
                                <div class="listing-detail__spec-value">${listing.transmission}</div>
                            </div>` : ''}
                            ${listing.condition ? `<div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Condition</div>
                                <div class="listing-detail__spec-value">${listing.condition}</div>
                            </div>` : ''}
                            ${listing.fuel_type ? `<div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Fuel</div>
                                <div class="listing-detail__spec-value">${listing.fuel_type}</div>
                            </div>` : ''}
                            <div class="listing-detail__spec">
                                <div class="listing-detail__spec-label">Location</div>
                                <div class="listing-detail__spec-value">${listing.location}</div>
                            </div>
                        </div>

                        ${listing.description ? `<div class="listing-detail__desc">${listing.description}</div>` : ''}

                        <div class="listing-detail__meta">
                            <p>Listing ID: <strong>${listing.id ? listing.id.slice(0,8) : 'N/A'}</strong></p>
                            <p>Listed: ${new Date(listing.created_at).toLocaleDateString('en-BW', { day:'numeric', month:'short', year:'numeric' })}</p>
                        </div>
                    </div>

                    <div class="listing-detail__sidebar">
                        <div class="listing-detail__seller-info">
                            <div class="car-card__seller-avatar" style="width:36px;height:36px;font-size:0.9rem;">${detailSellerInitial}</div>
                            <div>
                                <div style="font-weight:700;font-size:0.95rem;">${detailSellerName}</div>
                                <div style="font-size:0.78rem;color:var(--text-tertiary);">${listing.seller_type === 'dealer' ? 'Dealership' : 'Private Seller'}</div>
                            </div>
                        </div>
                        <h3>Interested in this car?</h3>
                        <button class="btn btn--primary" onclick="startConversation('${listing.id}', '${listing.user_id}')">
                            <i class="bi bi-chat-dots"></i> Message Seller
                        </button>
                        <button class="btn btn--accent" onclick="initCheckout('${listing.id}')">
                            <i class="bi bi-bag-check"></i> Buy This Car
                        </button>
                        <button class="btn btn--outline btn--sm" onclick="window.open('https://wa.me/26777625997?text=${encodeURIComponent(`Hi PrimeDrive, I need help with listing ${listing.id ? listing.id.slice(0,8) : ''}`)}', '_blank')">
                            <i class="bi bi-headset"></i> PrimeDrive Support
                        </button>

                        <div class="listing-detail__deposit-info">
                            <strong>Secure Transaction</strong><br>
                            Platform commission: <strong>${commission}</strong><br>
                            Seller receives: <strong>${formatPrice(Number(listing.price) - Number(listing.price) * (price < 100000 ? 0.05 : 0.065))}</strong><br><br>
                            Pay securely through PrimeDrive. Commission is deducted automatically on completed sales.
                        </div>
                    </div>
                </div>
            `;

        } catch (err) {
            console.error('Detail load error:', err);
            container.innerHTML = `<div class="no-results">
                <div class="no-results__icon"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="no-results__title">Could not load listing</div>
                <p class="body-sm">${err.message || 'Please try again.'}</p>
                <button class="btn btn--primary" onclick="navigate('buy')" style="margin-top:16px;">Back to Marketplace</button>
            </div>`;
        }
    }

    function switchPhoto(url, thumbEl) {
        document.getElementById('mainPhoto').src = url;
        document.querySelectorAll('.listing-detail__thumb').forEach(t => t.classList.remove('active'));
        if (thumbEl) thumbEl.classList.add('active');
    }


    /* ===========================================
       LEAD GENERATION & CONTACT
       =========================================== */
    function generateLeadCode() {
        return 'PD-' + Math.floor(10000 + Math.random() * 90000);
    }

    function getDepositAmount(price) {
        if (price >= 200000) return 2000;
        if (price >= 100000) return 1000;
        return 500;
    }

    async function contactSeller(listingId, type) {
        const listing = currentListingDetail || marketplaceListings.find(l => l.id === listingId);
        if (!listing) { alert('Listing not found'); return; }

        const leadCode = generateLeadCode();
        const price = Number(listing.price);

        // Log lead in Supabase
            try {
                await supabase.from('leads').insert({
                    lead_code: leadCode,
                    listing_id: listingId,
                    buyer_id: currentUser ? currentUser.id : null,
                    seller_id: listing.user_id,
                    lead_type: type,
                    status: 'open',
                });
                // Track click
                supabase.rpc('increment_whatsapp_clicks', { listing_uuid: listingId }).catch(() => {});
            } catch (err) {
                console.warn('Lead creation error:', err.message);
        }

        // Build WhatsApp message
        const title = listing.title || (listing.make + ' ' + listing.model + ' ' + listing.year);
        const msg = `Hello, I'm interested in this car on PrimeDrive:\n\n` +
            `Listing: ${title}\n` +
            `Price: ${formatPrice(price)}\n` +
            `Listing ID: ${listingId ? listingId.slice(0,8) : 'N/A'}\n` +
            `Lead Ref: ${leadCode}\n` +
            `Location: ${listing.location}`;

        const waNumber = type === 'whatsapp_primedrive' ? WHATSAPP : WHATSAPP; // Will use seller's WhatsApp when profile has it
        // Try to get seller's actual WhatsApp for seller contact
        if (type === 'whatsapp_seller' && listing.user_id) {
            try {
                const { data: sp } = await supabase.from('profiles').select('whatsapp, phone').eq('id', listing.user_id).single();
                if (sp) {
                    const sellerWa = sp.whatsapp || sp.phone;
                    if (sellerWa) {
                        const cleanNum = sellerWa.replace(/[^0-9]/g, '');
                        if (cleanNum.length >= 8) {
                            window.open(`https://wa.me/${cleanNum}?text=${encodeURIComponent(msg)}`, '_blank');
                            return;
                        }
                    }
                }
            } catch (err) { console.warn('Seller contact lookup failed'); }
        }
        window.open(`https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function requestVerifiedDeal(listingId) {
        const listing = currentListingDetail || marketplaceListings.find(l => l.id === listingId);
        if (!listing) { alert('Listing not found'); return; }

        const price = Number(listing.price);
        const deposit = getDepositAmount(price);
        const leadCode = generateLeadCode();
        const commission = price < 100000 ? '5%' : '6.5%';
        const title = listing.title || (listing.make + ' ' + listing.model + ' ' + listing.year);

        // Confirm with user
        const confirmed = confirm(
            `PrimeDrive Verified Deal\n\n` +
            `Car: ${title}\n` +
            `Price: ${formatPrice(price)}\n` +
            `Refundable Deposit: ${formatPrice(deposit)}\n` +
            `Commission on sale: ${commission}\n\n` +
            `Your deposit reserves this car and activates PrimeDrive's verification service. Continue?`
        );
        if (!confirmed) return;

        // Log lead
            try {
                await supabase.from('leads').insert({
                    lead_code: leadCode,
                    listing_id: listingId,
                    buyer_id: currentUser ? currentUser.id : null,
                    seller_id: listing.user_id,
                    lead_type: 'verified_deal_request',
                    status: 'open',
                    deposit_amount: deposit,
                });
                supabase.rpc('increment_whatsapp_clicks', { listing_uuid: listingId }).catch(() => {});
            } catch (err) {
                console.warn('Verified deal lead error:', err.message);
        }

        // Open WhatsApp to PrimeDrive
        const msg = `*VERIFIED DEAL REQUEST — PrimeDrive*\n\n` +
            `Listing: ${title}\n` +
            `Price: ${formatPrice(price)}\n` +
            `Listing ID: ${listingId ? listingId.slice(0,8) : 'N/A'}\n` +
            `Lead Ref: ${leadCode}\n` +
            `Deposit Required: ${formatPrice(deposit)}\n` +
            `Commission: ${commission}\n\n` +
            `I'd like to proceed with a PrimeDrive Verified Deal for this vehicle.`;

        window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`, '_blank');
    }


    /* ===========================================
       MY LISTINGS / DEALER DASHBOARD
       =========================================== */
    async function loadMyListings() {
        if (!currentUser) { navigate('home'); showLogin(); return; }

        const grid = document.getElementById('myListingsGrid');
        const countEl = document.getElementById('myListingsCount');
        countEl.textContent = 'Loading...';
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-tertiary);"><i class="bi bi-arrow-repeat spin" style="font-size:2rem;"></i></div>';

        try {
            // Fetch my listings
            const { data: listings, error } = await supabase
                .from('listings')
                .select('*, listing_photos(photo_url, display_order)')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const myListings = (listings || []).map(l => {
                const photos = l.listing_photos || [];
                photos.sort((a, b) => a.display_order - b.display_order);
                l.main_photo = photos.length ? photos[0].photo_url : '';
                return l;
            });

            countEl.textContent = `${myListings.length} listing${myListings.length !== 1 ? 's' : ''}`;

            if (myListings.length === 0) {
                grid.innerHTML = `<div class="no-results">
                    <div class="no-results__icon"><i class="bi bi-plus-circle"></i></div>
                    <div class="no-results__title">No listings yet</div>
                    <p class="body-sm">Create your first listing and start selling.</p>
                    <button class="btn btn--primary" onclick="navigate('sell')" style="margin-top:16px;">Create Listing</button>
                </div>`;
            } else {
                grid.innerHTML = myListings.map(car => {
                    const statusLabel = car.status === 'verified' ? 'Verified' : car.status === 'sold' ? 'Sold' : 'Unverified';
                    const statusColor = car.status === 'verified' ? '#16a34a' : car.status === 'sold' ? '#6366f1' : '#d97706';
                    return `
                    <div class="car-card reveal" onclick="openListingDetail('${car.id}')" style="cursor:pointer;">
                        <div class="car-card__image">
                            ${car.main_photo ? `<img src="${car.main_photo}" alt="${car.make} ${car.model}" loading="lazy">` : `<div style="height:100%;display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);"><i class="bi bi-car-front" style="font-size:3rem;color:var(--text-tertiary);"></i></div>`}
                            <div class="car-card__badge" style="background:${statusColor};">${statusLabel}</div>
                        </div>
                        <div class="car-card__body">
                            <div class="car-card__name">${car.make} ${car.model} ${car.year}</div>
                            <div class="car-card__specs">
                                <span class="car-card__spec"><i class="bi bi-eye"></i> ${car.views || 0} views</span>
                                <span class="car-card__spec"><i class="bi bi-chat-dots"></i> ${car.whatsapp_clicks || 0} inquiries</span>
                                <span class="car-card__spec"><i class="bi bi-geo-alt"></i> ${car.location}</span>
                            </div>
                            <div class="car-card__divider"></div>
                            <div class="car-card__footer">
                                <div class="car-card__price">${formatPrice(Number(car.price))}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            // Stats
            const totalViews = myListings.reduce((sum, l) => sum + (l.views || 0), 0);
            const totalClicks = myListings.reduce((sum, l) => sum + (l.whatsapp_clicks || 0), 0);
            document.getElementById('statMyListings').textContent = myListings.length;
            document.getElementById('statMyViews').textContent = totalViews;
            document.getElementById('statMyClicks').textContent = totalClicks;

            // Fetch leads
            const { data: leads } = await supabase
                .from('leads')
                .select('*')
                .eq('seller_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(50);

            document.getElementById('statMyLeads').textContent = (leads || []).length;

            const tbody = document.getElementById('myLeadsTableBody');
            if (leads && leads.length > 0) {
                tbody.innerHTML = leads.map(lead => {
                    const listing = myListings.find(l => l.id === lead.listing_id);
                    const listingName = listing ? `${listing.make} ${listing.model}` : lead.listing_id.slice(0,8);
                    const typeLabels = { whatsapp_seller: 'Message', whatsapp_primedrive: 'PD Support', verified_deal_request: 'Verified Deal' };
                    const statusColors = { open: '#3b82f6', contacted: '#8b5cf6', negotiating: '#f59e0b', closed: '#16a34a', lost: '#ef4444' };
                    return `<tr>
                        <td><code style="font-size:0.8rem;background:var(--bg-secondary);padding:2px 8px;border-radius:4px;">${lead.lead_code}</code></td>
                        <td>${listingName}</td>
                        <td>${typeLabels[lead.lead_type] || lead.lead_type}</td>
                        <td><span style="color:${statusColors[lead.status] || 'inherit'};font-weight:600;text-transform:capitalize;">${lead.status}</span></td>
                        <td>${new Date(lead.created_at).toLocaleDateString('en-BW', { day:'numeric', month:'short' })}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="admin__no-data">No leads yet</td></tr>';
            }

            // Load seller earnings
            await loadSellerEarnings();

            initRevealObserver();

        } catch (err) {
            console.error('My listings error:', err);
            countEl.textContent = 'Error loading';
            grid.innerHTML = `<div class="no-results"><p class="body-sm">Error: ${err.message}</p></div>`;
        }
    }


    /* ===========================================
       SOURCING FORM
       =========================================== */
    async function submitSourcingForm(e) {
        e.preventDefault();
        const d = {
            brand: val('srcBrand'), model: val('srcModel'),
            year: val('srcYear'), budget: val('srcBudget'),
            name: val('srcName'), notes: val('srcNotes')
        };

        if (!d.brand || !d.name) {
            alert('Please fill in at least your name and the brand you are looking for.');
            return;
        }

        const btn = e.target.querySelector('button[type="submit"]');
        const origText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Submitting...';

        try {
                await supabase.from('sourcing_requests').insert({
                    user_id: currentUser?.id || null,
                    brand: d.brand,
                    model: d.model || null,
                    year_range: d.year || null,
                    budget: d.budget || null,
                    contact_name: d.name,
                    notes: d.notes || null,
                    status: 'new'
                });

            e.target.reset();
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Request Submitted!';
            btn.style.background = '#16a34a';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = origText;
                btn.style.background = '';
            }, 3000);
        } catch (err) {
            console.error('Sourcing submit error:', err);
            btn.disabled = false;
            btn.innerHTML = origText;
            alert('Could not submit request. Please try again.');
        }
    }


    /* ===========================================
       UTILITIES
       =========================================== */
    function val(id) { return document.getElementById(id).value; }

    function appendOptions(selectId, items) {
        const sel = document.getElementById(selectId);
        items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            sel.appendChild(opt);
        });
    }


    /* ===========================================
       SCROLL REVEAL
       =========================================== */
    let revealObserver;
    function initRevealObserver() {
        if (revealObserver) revealObserver.disconnect();
        revealObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    revealObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.08, rootMargin: '0px 0px -30px 0px' });

        document.querySelectorAll('.reveal:not(.visible)').forEach(el => revealObserver.observe(el));
    }


    /* ===========================================
       SUPABASE AUTH — LOGIN / SIGNUP / SESSION
       =========================================== */
    function showLogin() {
        document.getElementById('loginOverlay').classList.add('active');
        document.getElementById('loginEmail').focus();
        document.body.style.overflow = 'hidden';
    }

    function hideLogin() {
        document.getElementById('loginOverlay').classList.remove('active');
        document.body.style.overflow = '';
        clearLoginError();
    }

    function clearLoginError() {
        const el = document.getElementById('loginError');
        el.classList.remove('show');
        el.textContent = '';
    }

    function showLoginError(msg) {
        const el = document.getElementById('loginError');
        el.textContent = msg;
        el.classList.add('show');
    }

    function togglePasswordVis() {
        const inp = document.getElementById('loginPassword');
        const icon = document.getElementById('passEyeIcon');
        if (inp.type === 'password') {
            inp.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            inp.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    let showingSignup = false;
    function switchToSignup() {
        showingSignup = !showingSignup;
        document.getElementById('loginForm').style.display = showingSignup ? 'none' : '';
        document.getElementById('signupForm').style.display = showingSignup ? '' : 'none';
        document.getElementById('loginSignupSwitch').style.display = showingSignup ? 'none' : '';
        document.getElementById('loginAltText').innerHTML = showingSignup
            ? 'Already have an account? <a onclick="switchToSignup()">Sign in</a>'
            : 'New here? Create an account to start listing.';
        clearLoginError();
    }


    async function handleLogin(e) {
        e.preventDefault();
        clearLoginError();
        const btn = document.getElementById('loginSubmitBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Signing in...';

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            currentUser = data.user;
            await loadProfile();
            onLoginSuccess();
            hideLogin();
        } catch (err) {
            showLoginError(err.message || 'Invalid email or password');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-right"></i> Sign In';
        }
    }

    async function handleGoogleLogin() {
        if (authErr) {
            showLoginError(authErr);
            return;
        }
        const btn = document.getElementById('googleLoginBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Connecting...';
        try {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname
                }
            });
            if (error) throw error;
            // Browser will redirect to Google — nothing more to do here
        } catch (err) {
            showLoginError(err.message || 'Google sign-in failed');
            btn.disabled = false;
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" style="margin-right:8px;flex-shrink:0;"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Continue with Google';
        }
    }

    async function handleSignup(e) {
        e.preventDefault();
        clearLoginError();
        const btn = document.getElementById('signupSubmitBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Creating account...';

        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const fullName = document.getElementById('signupName').value || '';
        const phone = document.getElementById('signupPhone').value || null;
        const whatsapp = document.getElementById('signupWhatsApp').value || null;

        try {
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { full_name: fullName, phone, whatsapp }
                }
            });
            if (error) throw error;

            // Check if email confirmation is required
            if (data.user && !data.session) {
                showLoginError('Check your email for a confirmation link, then sign in.');
                switchToSignup(); // Switch back to login view
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg"></i> Create Account';
                return;
            }

            currentUser = data.user;
            await loadProfile();
            onLoginSuccess();
            hideLogin();
        } catch (err) {
            showLoginError(err.message || 'Could not create account');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Create Account';
        }
    }

    async function loadProfile() {
        if (!currentUser) return;
        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        if (error) {
            console.error('Profile load error:', error.message);
            currentProfile = {
                email: currentUser.email,
                current_tier: 'free',
                listing_count: 0,
                listing_limit: 1,
                is_admin: false,
            };
        } else {
            currentProfile = data;
        }
        isAdmin = currentProfile.is_admin || false;
    }

    function onLoginSuccess() {
        // Update nav
        document.getElementById('navLoginBtn').style.display = 'none';
        document.getElementById('navUserBtn').style.display = '';
        document.getElementById('mobileLoginBtn').style.display = 'none';
        document.getElementById('mobileDashBtn').style.display = '';
        var navMyLink = document.getElementById('navMyListingsLink');
        if (navMyLink) navMyLink.style.display = '';
        var mobileMyLink = document.getElementById('mobileMyListingsBtn');
        if (mobileMyLink) mobileMyLink.style.display = '';
        // Messages
        var navMsgBtn = document.getElementById('navMessagesBtn');
        if (navMsgBtn) navMsgBtn.style.display = '';
        var mobileMsgBtn = document.getElementById('mobileMessagesBtn');
        if (mobileMsgBtn) mobileMsgBtn.style.display = '';
        var navNotifWrap = document.getElementById('navNotifWrap');
        if (navNotifWrap) navNotifWrap.style.display = '';
        updateUnreadBadge();
        updateNotifBadge();

        // Update user bar
        if (currentProfile) {
            document.getElementById('userBar').style.display = '';
            document.getElementById('userAvatar').textContent = (currentProfile.full_name || currentProfile.email || 'U')[0].toUpperCase();
            document.getElementById('userDisplayName').textContent = currentProfile.full_name || currentProfile.email;
            updateTierDisplay();
        }

        // Navigate to dashboard
        navigate('dashboard');
        loadBuyerPurchases();

        // Show admin panel only for admins
        if (isAdmin) {
            document.getElementById('adminSection').style.display = '';
            loadAdminData();
        } else {
            document.getElementById('adminSection').style.display = 'none';
        }
    }

    async function handleLogout() {
            try { await supabase.auth.signOut(); } catch(e) {}
        currentUser = null;
        currentProfile = null;
        isAdmin = false;

        document.getElementById('navLoginBtn').style.display = '';
        document.getElementById('navUserBtn').style.display = 'none';
        document.getElementById('mobileLoginBtn').style.display = '';
        document.getElementById('mobileDashBtn').style.display = 'none';
        document.getElementById('userBar').style.display = 'none';
        document.getElementById('adminSection').style.display = 'none';
        var navMyLink = document.getElementById('navMyListingsLink');
        if (navMyLink) navMyLink.style.display = 'none';
        var mobileMyLink = document.getElementById('mobileMyListingsBtn');
        if (mobileMyLink) mobileMyLink.style.display = 'none';
        // Messages
        var navMsgBtn = document.getElementById('navMessagesBtn');
        if (navMsgBtn) navMsgBtn.style.display = 'none';
        var mobileMsgBtn = document.getElementById('mobileMessagesBtn');
        if (mobileMsgBtn) mobileMsgBtn.style.display = 'none';
        var msgBadge = document.getElementById('navMsgBadge');
        if (msgBadge) msgBadge.style.display = 'none';
        var navNotifWrap = document.getElementById('navNotifWrap');
        if (navNotifWrap) navNotifWrap.style.display = 'none';
        var notifPanel = document.getElementById('notifPanel');
        if (notifPanel) notifPanel.style.display = 'none';
        if (messageSubscription) { messageSubscription.unsubscribe(); messageSubscription = null; }
        activeConversation = null;

        // Reset tier buttons to default
        resetTierButtons();

        navigate('home');
    }

    function resetTierButtons() {
        const defaults = {
            Free: `<div class="tier-card__current"><i class="bi bi-check2"></i> Current Plan</div>`,
            Basic: `<button class="btn btn--secondary btn--full" onclick="initiatePurchase('basic')">Upgrade to Basic</button>`,
            Standard: `<button class="btn btn--primary btn--full" onclick="initiatePurchase('standard')">Upgrade to Standard</button>`,
            Premium: `<button class="btn btn--secondary btn--full" onclick="initiatePurchase('premium')">Upgrade to Premium</button>`,
        };
        Object.entries(defaults).forEach(([tier, html]) => {
            const container = document.getElementById('tierCta' + tier);
            if (container) container.innerHTML = html;
        });
    }

    async function restoreSession() {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) return;
            currentUser = session.user;
            await loadProfile();
            onLoginSuccess();
        } catch (err) {
            console.warn('[PrimeDrive] Session restore failed:', err.message);
        }
    }


    /* ===========================================
       IN-APP MESSAGING
       =========================================== */
    let activeConversation = null;
    let messageSubscription = null;
    let allConversations = [];

    async function startConversation(listingId, sellerId) {
        if (!currentUser) { showLogin(); return; }
        if (currentUser.id === sellerId) { alert('This is your own listing.'); return; }
        try {
            // Check if conversation already exists
            const { data: existing } = await supabase
                .from('conversations')
                .select('id')
                .eq('listing_id', listingId)
                .eq('buyer_id', currentUser.id)
                .eq('seller_id', sellerId)
                .single();

            if (existing) {
                navigate('messages');
                setTimeout(() => openChat(existing.id), 300);
                return;
            }

            // Create new conversation
            const { data: conv, error } = await supabase
                .from('conversations')
                .insert({ listing_id: listingId, buyer_id: currentUser.id, seller_id: sellerId })
                .select()
                .single();

            if (error) throw error;

            navigate('messages');
            setTimeout(() => {
                loadConversations();
                openChat(conv.id);
            }, 300);

        } catch (err) {
            console.error('Start conversation error:', err);
            alert('Could not start conversation. Please try again.');
        }
    }

    async function loadConversations() {
        if (!currentUser) return;
        const listEl = document.getElementById('msgConvList');
        const countEl = document.getElementById('msgCount');
        if (!listEl) return;

        try {
            const { data: convs, error } = await supabase
                .from('conversations')
                .select(`
                    *,
                    listings(make, model, year, main_photo),
                    buyer:profiles!conversations_buyer_id_fkey(full_name, email),
                    seller:profiles!conversations_seller_id_fkey(full_name, email)
                `)
                .or(`buyer_id.eq.${currentUser.id},seller_id.eq.${currentUser.id}`)
                .order('last_message_at', { ascending: false, nullsFirst: false });

            if (error) throw error;
            allConversations = convs || [];

            if (allConversations.length === 0) {
                countEl.textContent = 'No conversations yet';
                listEl.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-tertiary);">
                    <i class="bi bi-chat-dots" style="font-size:2rem;display:block;margin-bottom:8px;"></i>
                    When you message a seller, your conversations will appear here.
                </div>`;
                return;
            }

            countEl.textContent = allConversations.length + ' conversation' + (allConversations.length !== 1 ? 's' : '');

            // Get unread counts per conversation
            const { data: unreads } = await supabase
                .from('messages')
                .select('conversation_id')
                .eq('read', false)
                .neq('sender_id', currentUser.id);

            const unreadMap = {};
            (unreads || []).forEach(m => {
                unreadMap[m.conversation_id] = (unreadMap[m.conversation_id] || 0) + 1;
            });

            listEl.innerHTML = allConversations.map(c => {
                const other = c.buyer_id === currentUser.id ? c.seller : c.buyer;
                const otherName = other ? (other.full_name || other.email || 'User') : 'User';
                const initial = otherName.charAt(0).toUpperCase();
                const listing = c.listings;
                const carLabel = listing ? `${listing.make} ${listing.model}` : 'Listing';
                const preview = c.last_message || 'No messages yet';
                const time = c.last_message_at ? timeAgo(new Date(c.last_message_at)) : '';
                const unread = unreadMap[c.id] || 0;
                const isActive = activeConversation === c.id ? ' msg-conv--active' : '';

                return `<div class="msg-conv${isActive}" onclick="openChat('${c.id}')">
                    <div class="msg-conv__avatar">${initial}</div>
                    <div class="msg-conv__info">
                        <div class="msg-conv__name">${otherName}</div>
                        <div class="msg-conv__preview">${carLabel} · ${escapeHTML(preview.slice(0, 50))}</div>
                    </div>
                    <div class="msg-conv__meta">
                        <span class="msg-conv__time">${time}</span>
                        ${unread > 0 ? `<span class="msg-conv__unread">${unread}</span>` : ''}
                    </div>
                </div>`;
            }).join('');

        } catch (err) {
            console.error('Load conversations error:', err);
            listEl.innerHTML = '<div style="padding:20px;color:var(--text-tertiary);text-align:center;">Could not load conversations.</div>';
        }
    }

    async function openChat(convId) {
        activeConversation = convId;
        const panel = document.getElementById('msgChatPanel');
        if (!panel) return;

        const conv = allConversations.find(c => c.id === convId);
        if (!conv) { await loadConversations(); return; }

        const other = conv.buyer_id === currentUser.id ? conv.seller : conv.buyer;
        const otherName = other ? (other.full_name || other.email || 'User') : 'User';
        const initial = otherName.charAt(0).toUpperCase();
        const listing = conv.listings;
        const carLabel = listing ? `${listing.make} ${listing.model} ${listing.year || ''}` : '';

        panel.innerHTML = `
            <div class="msg-chat__header">
                <div class="msg-conv__avatar">${initial}</div>
                <div>
                    <div class="msg-chat__header-name">${otherName}</div>
                    <div class="msg-chat__header-listing">${carLabel}</div>
                </div>
            </div>
            <div class="msg-chat__body" id="chatBody"></div>
            <div class="msg-chat__input">
                <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()" maxlength="2000" autocomplete="off">
                <button onclick="sendMessage()"><i class="bi bi-send"></i></button>
            </div>
        `;

        // Load messages
        await loadMessages(convId);

        // Mark as read
        await supabase
            .from('messages')
            .update({ read: true })
            .eq('conversation_id', convId)
            .neq('sender_id', currentUser.id)
            .eq('read', false);

        // Subscribe to new messages via Realtime
        if (messageSubscription) messageSubscription.unsubscribe();
        messageSubscription = supabase
            .channel('chat-' + convId)
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'messages',
                filter: 'conversation_id=eq.' + convId
            }, (payload) => {
                appendMessage(payload.new);
                // Auto-mark as read if we're viewing this chat
                if (payload.new.sender_id !== currentUser.id) {
                    supabase.from('messages').update({ read: true }).eq('id', payload.new.id).then(() => {});
                }
            })
            .subscribe();

        // Update active state in list
        document.querySelectorAll('.msg-conv').forEach(el => el.classList.remove('msg-conv--active'));
        const convEl = document.querySelector(`.msg-conv[onclick="openChat('${convId}')"]`);
        if (convEl) convEl.classList.add('msg-conv--active');

        // Focus input
        document.getElementById('chatInput')?.focus();
    }

    async function loadMessages(convId) {
        const body = document.getElementById('chatBody');
        if (!body) return;

        const { data: msgs, error } = await supabase
            .from('messages')
            .select('*')
            .eq('conversation_id', convId)
            .order('created_at', { ascending: true })
            .limit(100);

        if (error) { console.error(error); return; }

        body.innerHTML = (msgs || []).map(m => messageBubble(m)).join('');
        body.scrollTop = body.scrollHeight;
    }

    function messageBubble(m) {
        const isMine = m.sender_id === currentUser.id;
        const cls = isMine ? 'msg-bubble--sent' : 'msg-bubble--received';
        const time = new Date(m.created_at).toLocaleTimeString('en-BW', { hour: '2-digit', minute: '2-digit' });
        return `<div class="msg-bubble ${cls}">
            ${escapeHTML(m.body)}
            <div class="msg-bubble__time">${time}</div>
        </div>`;
    }

    function appendMessage(m) {
        const body = document.getElementById('chatBody');
        if (!body) return;
        body.insertAdjacentHTML('beforeend', messageBubble(m));
        body.scrollTop = body.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        if (!input || !activeConversation || !currentUser) return;
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        input.disabled = true;

        try {
            const { error } = await supabase.from('messages').insert({
                conversation_id: activeConversation,
                sender_id: currentUser.id,
                body: text
            });
            if (error) throw error;
        } catch (err) {
            console.error('Send message error:', err);
            input.value = text;
            alert('Failed to send message.');
        }

        input.disabled = false;
        input.focus();
    }

    function escapeHTML(str) {
        const d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    function timeAgo(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return 'now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd';
        return date.toLocaleDateString('en-BW', { day: 'numeric', month: 'short' });
    }

    async function updateUnreadBadge() {
        if (!currentUser) return;
        try {
            const { data } = await supabase.rpc('get_unread_count', { user_uuid: currentUser.id });
            const badge = document.getElementById('navMsgBadge');
            if (badge) {
                if (data && data > 0) {
                    badge.textContent = data > 99 ? '99+' : data;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch (err) { /* silent */ }
    }


    /* ===========================================
       CHECKOUT / TRANSACTIONS
       =========================================== */
    let checkoutListing = null;

    async function initCheckout(listingId) {
        if (!currentUser) { showLogin(); return; }
        navigate('checkout');
        const content = document.getElementById('checkoutContent');
        content.innerHTML = '<div style="text-align:center;padding:40px;"><i class="bi bi-arrow-repeat spin" style="font-size:1.5rem;"></i></div>';

        try {
            const { data: listing, error } = await supabase
                .from('listings')
                .select('*, listing_photos(photo_url, display_order), profiles(full_name, email)')
                .eq('id', listingId)
                .single();

            if (error || !listing) throw error || new Error('Listing not found');
            if (listing.user_id === currentUser.id) {
                content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-tertiary);">You cannot buy your own listing.</div>';
                return;
            }

            checkoutListing = listing;
            const photos = (listing.listing_photos || []).sort((a, b) => a.display_order - b.display_order);
            const photo = photos.length ? photos[0].photo_url : '';
            const price = Number(listing.price);
            const seller = listing.profiles;
            const sellerName = seller ? (seller.full_name || seller.email) : 'Seller';

            // Get commission rate from database
            const { data: rate } = await supabase.rpc('get_commission_rate', { price: price });
            const commissionRate = rate || (price < 100000 ? 0.05 : 0.065);
            const commission = Math.round(price * commissionRate);
            const sellerNet = price - commission;

            content.innerHTML = `
                <div class="checkout-card">
                    <div class="checkout-card__car">
                        ${photo ? `<img src="${photo}" alt="${listing.make} ${listing.model}">` : ''}
                        <div class="checkout-card__car-info">
                            <h3>${listing.make} ${listing.model} ${listing.year || ''}</h3>
                            <p style="font-size:0.82rem;color:var(--text-tertiary);">Sold by ${sellerName}</p>
                            <p style="font-size:0.82rem;color:var(--text-tertiary);">${listing.location || ''}</p>
                        </div>
                    </div>

                    <div class="checkout-card__breakdown">
                        <div class="checkout-card__row">
                            <span>Vehicle Price</span>
                            <span>${formatPrice(price)}</span>
                        </div>
                        <div class="checkout-card__row">
                            <span>Buyer Fee</span>
                            <span style="color:#22c55e;">Free</span>
                        </div>
                        <div class="checkout-card__row checkout-card__row--total">
                            <span>Total</span>
                            <span>${formatPrice(price)}</span>
                        </div>
                    </div>

                    <div class="checkout-card__methods">
                        <p style="font-weight:600;margin-bottom:12px;">Payment Method</p>
                        <label class="checkout-card__method checkout-card__method--selected" onclick="selectPayMethod(this, 'orange_money')">
                            <input type="radio" name="payMethod" value="orange_money" checked>
                            <i class="bi bi-phone"></i>
                            <div>
                                <div style="font-weight:600;">Orange Money</div>
                                <div style="font-size:0.78rem;color:var(--text-tertiary);">Pay via Orange Money transfer</div>
                            </div>
                        </label>
                        <label class="checkout-card__method" onclick="selectPayMethod(this, 'bank_transfer')">
                            <input type="radio" name="payMethod" value="bank_transfer">
                            <i class="bi bi-bank"></i>
                            <div>
                                <div style="font-weight:600;">Bank Transfer</div>
                                <div style="font-size:0.78rem;color:var(--text-tertiary);">Pay via bank deposit or EFT</div>
                            </div>
                        </label>
                    </div>

                    <div class="checkout-card__actions">
                        <button class="btn btn--primary btn--lg btn--full" id="checkoutConfirmBtn" onclick="createTransaction('${listingId}', ${price}, ${commissionRate})">
                            <i class="bi bi-lock"></i> Confirm &amp; Get Payment Details
                        </button>
                        <p style="text-align:center;font-size:0.75rem;color:var(--text-tertiary);margin-top:12px;">
                            Secure transaction powered by PrimeDrive. Commission is deducted from the seller, not you.
                        </p>
                    </div>
                </div>
            `;
        } catch (err) {
            console.error('Checkout error:', err);
            content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-tertiary);">Could not load checkout. Please try again.</div>';
        }
    }

    function selectPayMethod(el, method) {
        document.querySelectorAll('.checkout-card__method').forEach(m => m.classList.remove('checkout-card__method--selected'));
        el.classList.add('checkout-card__method--selected');
    }

    async function createTransaction(listingId, price, commissionRate) {
        const btn = document.getElementById('checkoutConfirmBtn');
        if (!btn || btn.disabled) return;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Processing...';

        const payMethod = document.querySelector('input[name="payMethod"]:checked')?.value || 'orange_money';

        try {
            // Generate transaction ref
            const { data: ref } = await supabase.rpc('generate_txn_ref');
            const txnRef = ref || 'PD-TXN-' + Math.random().toString(36).slice(2, 7).toUpperCase();

            const commission = Math.round(price * commissionRate);
            const sellerNet = price - commission;

            const { data: txn, error } = await supabase
                .from('sale_transactions')
                .insert({
                    transaction_ref: txnRef,
                    listing_id: listingId,
                    buyer_id: currentUser.id,
                    seller_id: checkoutListing.user_id,
                    gross_amount: price,
                    commission_rate: commissionRate,
                    commission_amount: commission,
                    seller_net_amount: sellerNet,
                    payment_method: payMethod,
                    status: 'INITIATED'
                })
                .select()
                .single();

            if (error) throw error;

            // Show payment instructions
            showPaymentInstructions(txn, payMethod);

        } catch (err) {
            console.error('Transaction error:', err);
            alert('Could not create transaction: ' + (err.message || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lock"></i> Confirm &amp; Get Payment Details';
        }
    }

    function showPaymentInstructions(txn, method) {
        const content = document.getElementById('checkoutContent');
        const listing = checkoutListing;
        const carName = listing ? `${listing.make} ${listing.model} ${listing.year || ''}` : 'Vehicle';

        const instructions = method === 'orange_money'
            ? `<strong>Orange Money Instructions:</strong><br>
               1. Dial *145# on your Orange line<br>
               2. Select "Send Money"<br>
               3. Enter PrimeDrive number: <strong>77 625 997</strong><br>
               4. Amount: <strong>${formatPrice(txn.gross_amount)}</strong><br>
               5. Use reference: <strong>${txn.transaction_ref}</strong><br>
               6. Confirm the transfer<br>
               7. Come back here and tap "I've Paid"`
            : `<strong>Bank Transfer Instructions:</strong><br>
               Bank: First National Bank Botswana<br>
               Account Name: PrimeDrive (Pty) Ltd<br>
               Account Number: <strong>62843021547</strong><br>
               Branch Code: <strong>282267</strong><br>
               Amount: <strong>${formatPrice(txn.gross_amount)}</strong><br>
               Reference: <strong>${txn.transaction_ref}</strong><br><br>
               After sending, come back here and tap "I've Paid"`;

        content.innerHTML = `
            <div class="checkout-card">
                <div style="padding:24px;text-align:center;">
                    <i class="bi bi-check-circle" style="font-size:2.5rem;color:#22c55e;"></i>
                    <h3 style="margin-top:12px;">Transaction Created</h3>
                    <p style="color:var(--text-tertiary);margin-top:4px;">${carName}</p>
                </div>

                <div class="checkout-card__ref">
                    <div class="checkout-card__ref-label">Your Payment Reference</div>
                    <div class="checkout-card__ref-code">${txn.transaction_ref}</div>
                </div>

                <div class="checkout-card__breakdown">
                    <div class="checkout-card__row">
                        <span>Amount to Pay</span>
                        <span style="font-weight:700;">${formatPrice(txn.gross_amount)}</span>
                    </div>
                    <div class="checkout-card__row">
                        <span>Method</span>
                        <span>${method === 'orange_money' ? 'Orange Money' : 'Bank Transfer'}</span>
                    </div>
                    <div class="checkout-card__row">
                        <span>Status</span>
                        <span style="color:#f59e0b;font-weight:600;">Awaiting Payment</span>
                    </div>
                </div>

                <div class="checkout-card__instructions">
                    ${instructions}
                </div>

                <div class="checkout-card__actions">
                    <button class="btn btn--primary btn--lg btn--full" onclick="confirmPayment('${txn.id}')">
                        <i class="bi bi-check-lg"></i> I've Paid
                    </button>
                    <button class="btn btn--ghost btn--sm btn--full" onclick="navigate('buy')" style="margin-top:8px;">
                        Cancel Transaction
                    </button>
                </div>
            </div>
        `;
    }

    async function confirmPayment(txnId) {
        try {
            const { error } = await supabase
                .from('sale_transactions')
                .update({ status: 'PAID', updated_at: new Date().toISOString() })
                .eq('id', txnId)
                .eq('buyer_id', currentUser.id);

            if (error) throw error;

            showToast('success', 'Payment Submitted', 'We are verifying your payment. You will be notified when confirmed.');

            // Notify seller
            if (checkoutListing) {
                await createNotification(checkoutListing.user_id, 'sale', 'New Purchase', `A buyer has paid for your ${checkoutListing.make} ${checkoutListing.model}. Awaiting admin confirmation.`, txnId);
            }

            const content = document.getElementById('checkoutContent');
            content.innerHTML = `
                <div style="text-align:center;padding:48px 24px;">
                    <i class="bi bi-hourglass-split" style="font-size:3rem;color:var(--accent);"></i>
                    <h3 style="margin-top:16px;">Payment Submitted</h3>
                    <p style="color:var(--text-tertiary);margin-top:8px;max-width:400px;margin-left:auto;margin-right:auto;">
                        We're verifying your payment. You'll be notified once it's confirmed and the seller has been paid. This usually takes less than 24 hours.
                    </p>
                    <button class="btn btn--primary" onclick="navigate('buy')" style="margin-top:24px;">
                        <i class="bi bi-arrow-left"></i> Back to Marketplace
                    </button>
                </div>
            `;
        } catch (err) {
            console.error('Confirm payment error:', err);
            alert('Error: ' + (err.message || 'Could not confirm payment.'));
        }
    }


    /* ===========================================
       BUYER PURCHASES
       =========================================== */
    async function loadBuyerPurchases() {
        if (!currentUser) return;
        try {
            const { data: purchases, error } = await supabase
                .from('sale_transactions')
                .select('*, listings(make, model, year)')
                .eq('buyer_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) throw error;
            const txns = purchases || [];

            const section = document.getElementById('buyerPurchasesSection');
            if (!txns.length) {
                section.style.display = 'none';
                return;
            }

            section.style.display = '';
            const tbody = document.getElementById('buyerPurchasesBody');
            tbody.innerHTML = txns.map(t => {
                const car = t.listings ? `${t.listings.make} ${t.listings.model} ${t.listings.year || ''}` : '—';
                const sColor = {
                    INITIATED: '#6b7280', PAID: '#3b82f6', PENDING_RELEASE: '#f59e0b',
                    RELEASED: '#16a34a', DISPUTED: '#ef4444', REFUNDED: '#8b5cf6', CANCELLED: '#6b7280'
                }[t.status] || '#6b7280';
                const sLabel = {
                    INITIATED: 'Awaiting Payment', PAID: 'Payment Sent', PENDING_RELEASE: 'Verifying',
                    RELEASED: 'Complete', DISPUTED: 'Disputed', REFUNDED: 'Refunded', CANCELLED: 'Cancelled'
                }[t.status] || t.status;

                return `<tr>
                    <td><code style="font-size:0.75rem;">${t.transaction_ref}</code></td>
                    <td>${car}</td>
                    <td><strong>${formatPrice(Number(t.gross_amount))}</strong></td>
                    <td>${formatMethod(t.payment_method)}</td>
                    <td><span style="color:${sColor};font-weight:600;font-size:0.8rem;">${sLabel}</span></td>
                    <td style="font-size:0.78rem;">${formatDate(t.created_at)}</td>
                    <td>
                        <div class="admin__actions">
                            ${t.status === 'RELEASED' ? `<button class="admin__btn admin__btn--approve" onclick="showReceipt('${t.id}')" title="Receipt"><i class="bi bi-receipt"></i></button>` : ''}
                            ${(t.status === 'PAID' || t.status === 'PENDING_RELEASE') ? `<button class="admin__btn admin__btn--reject" onclick="openDispute('${t.id}')" title="Report Issue"><i class="bi bi-flag"></i></button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('Buyer purchases error:', err);
        }
    }


    /* ===========================================
       SELLER EARNINGS
       =========================================== */
    async function loadSellerEarnings() {
        if (!currentUser) return;

        try {
            const { data: sales, error } = await supabase
                .from('sale_transactions')
                .select('*, listings(make, model, year)')
                .eq('seller_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) throw error;
            const txns = sales || [];

            const completed = txns.filter(t => t.status === 'RELEASED');
            const totalGross = completed.reduce((s, t) => s + Number(t.gross_amount || 0), 0);
            const totalComm = completed.reduce((s, t) => s + Number(t.commission_amount || 0), 0);
            const totalNet = completed.reduce((s, t) => s + Number(t.seller_net_amount || 0), 0);

            document.getElementById('statSellerSales').textContent = completed.length;
            document.getElementById('statSellerGross').textContent = formatPrice(totalGross);
            document.getElementById('statSellerCommission').textContent = formatPrice(totalComm);
            document.getElementById('statSellerNet').textContent = formatPrice(totalNet);

            const tbody = document.getElementById('sellerPayoutsBody');
            if (!txns.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="admin__no-data">No sales yet — your earnings will appear here</td></tr>';
                return;
            }

            tbody.innerHTML = txns.map(t => {
                const car = t.listings ? `${t.listings.make} ${t.listings.model} ${t.listings.year || ''}` : '—';
                const sColor = {
                    INITIATED: '#6b7280', PAID: '#3b82f6', PENDING_RELEASE: '#f59e0b',
                    RELEASED: '#16a34a', DISPUTED: '#ef4444', REFUNDED: '#8b5cf6', CANCELLED: '#6b7280'
                }[t.status] || '#6b7280';
                const sLabel = {
                    INITIATED: 'Awaiting Payment', PAID: 'Payment Received', PENDING_RELEASE: 'Processing',
                    RELEASED: 'Paid Out', DISPUTED: 'Disputed', REFUNDED: 'Refunded', CANCELLED: 'Cancelled'
                }[t.status] || t.status;

                return `<tr>
                    <td><code style="font-size:0.75rem;">${t.transaction_ref}</code></td>
                    <td>${car}</td>
                    <td>${formatPrice(Number(t.gross_amount))}</td>
                    <td style="color:#ef4444;">${formatPrice(Number(t.commission_amount))}</td>
                    <td style="font-weight:700;color:#16a34a;">${formatPrice(Number(t.seller_net_amount))}</td>
                    <td><span style="color:${sColor};font-weight:600;font-size:0.8rem;">${sLabel}</span></td>
                    <td style="font-size:0.78rem;">${formatDate(t.created_at)}</td>
                    <td>
                        ${t.status === 'RELEASED' ? `<button class="admin__btn admin__btn--approve" onclick="showReceipt('${t.id}')" title="Receipt"><i class="bi bi-receipt"></i></button>` : ''}
                        ${t.status === 'PENDING_RELEASE' ? `<button class="admin__btn admin__btn--reject" onclick="openDispute('${t.id}')" title="Report Issue"><i class="bi bi-flag"></i></button>` : ''}
                    </td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('Seller earnings error:', err);
        }
    }


    /* ===========================================
       SUBSCRIPTION / PAYWALL
       =========================================== */
    function updateTierDisplay() {
        if (!currentProfile) return;
        const limit = currentProfile.listing_limit === null ? '∞' : currentProfile.listing_limit;
        document.getElementById('userTierDisplay').textContent =
            `${capitalize(currentProfile.current_tier)} Tier · ${currentProfile.listing_count}/${limit} Listings`;

        // Rebuild tier buttons properly (non-destructive)
        const tiers = ['free', 'basic', 'standard', 'premium'];
        const tierOrder = { free: 0, basic: 1, standard: 2, premium: 3 };
        const currentIdx = tierOrder[currentProfile.current_tier] || 0;

        tiers.forEach(tier => {
            const container = document.getElementById('tierCta' + capitalize(tier));
            if (!container) return;
            const idx = tierOrder[tier];

            if (tier === currentProfile.current_tier) {
                container.innerHTML = `<div class="tier-card__current"><i class="bi bi-check2"></i> Current Plan</div>`;
            } else if (idx < currentIdx) {
                container.innerHTML = `<div class="tier-card__current" style="opacity:0.5;"><i class="bi bi-check2"></i> Included</div>`;
            } else {
                // Higher tier — show upgrade button
                const isPrimary = tier === 'standard';
                const btnClass = isPrimary ? 'btn--primary' : 'btn--secondary';
                container.innerHTML = `<button class="btn ${btnClass} btn--full" onclick="initiatePurchase('${tier}')">Upgrade to ${capitalize(tier)}</button>`;
            }
        });
    }

    function selectPayMethod(el) {
        document.querySelectorAll('.pay-method').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        selectedPayMethod = el.dataset.method;
    }

    async function initiatePurchase(tier) {
        if (!currentUser) {
            showLogin();
            return;
        }

        const container = document.getElementById('tierCta' + capitalize(tier));
        const btn = container ? container.querySelector('button') : null;
        if (!btn || btn.disabled) return;
        const origHTML = btn.innerHTML;
        btn.disabled = true;
        btn.textContent = 'Processing...';

        try {
            const config = TIER_CONFIG[tier];
            if (!config) throw new Error('Invalid tier');

            // Generate a transaction reference
            const ref = 'PD-' + Date.now().toString(36).toUpperCase();

            // Create transaction record in Supabase (if configured)
                const { data: txn, error } = await supabase
                    .from('transactions')
                    .insert({
                        user_id: currentUser.id,
                        tier_name: tier,
                        amount_pula: config.price,
                        payment_method: selectedPayMethod,
                        status: 'pending',
                        transaction_reference: ref,
                    })
                    .select()
                    .single();
                if (error) throw error;

            // Build WhatsApp payment message
            const payMsg =
                `*SUBSCRIPTION PAYMENT — PrimeDrive*\n\n` +
                `Reference: ${ref}\n` +
                `Plan: ${config.label}\n` +
                `Amount: P${config.price}/month\n` +
                `Method: ${formatMethod(selectedPayMethod)}\n` +
                `Email: ${currentProfile.email}\n\n` +
                `I'd like to activate my ${config.label} subscription.`;

            // Open WhatsApp with payment details
            window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(payMsg)}`, '_blank');

            alert(
                `Payment request created!\n\n` +
                `Reference: ${ref}\n` +
                `Amount: P${config.price}\n\n` +
                `Send the payment via ${formatMethod(selectedPayMethod)} with your reference number. We'll activate your plan within 24 hours.`
            );

        } catch (err) {
            alert('Payment error: ' + err.message);
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = origHTML;
            }
        }
    }


    /* ===========================================
       ADMIN DASHBOARD (Supabase)
       =========================================== */
    async function loadAdminData() {
        if (!currentUser || !isAdmin) return;
        try {
            // Load ALL transactions (admin RLS policy allows this)
            const { data: allTxns, error: txnErr } = await supabase
                .from('transactions')
                .select('*, profiles(email)')
                .order('created_at', { ascending: false });

            if (txnErr) throw txnErr;

            const pending = allTxns.filter(t => t.status === 'pending' || t.status === 'awaiting_verification');
            renderPendingTable(pending);
            renderRecentTable(allTxns);

            // Stats
            const pendingCount = allTxns.filter(t => t.status === 'pending').length;
            const awaitingCount = allTxns.filter(t => t.status === 'awaiting_verification').length;
            const today = new Date().toISOString().split('T')[0];
            const completedToday = allTxns.filter(t =>
                t.status === 'completed' && t.completed_at && t.completed_at.startsWith(today)
            ).length;
            const totalRevenue = allTxns
                .filter(t => t.status === 'completed')
                .reduce((sum, t) => sum + (t.amount_pula || 0), 0);

            document.getElementById('statPending').textContent = pendingCount;
            document.getElementById('statAwaiting').textContent = awaitingCount;
            document.getElementById('statCompleted').textContent = completedToday;
            document.getElementById('statRevenue').textContent = 'P' + totalRevenue.toLocaleString();

            // Also load sale transactions
            await loadAdminSaleTransactions();

            // Also load sourcing requests
            await loadAdminSourcingRequests();

            // Also load disputes
            await loadAdminDisputes();
        } catch (err) {
            console.error('Admin data load error:', err);
        }
    }

    function renderPendingTable(payments) {
        const tbody = document.getElementById('pendingTableBody');
        if (!payments.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="admin__no-data">No pending payments — all clear!</td></tr>';
            return;
        }
        tbody.innerHTML = payments.map(p => `
            <tr>
                <td><code style="font-size:0.8rem;">${p.transaction_reference || '—'}</code></td>
                <td>${p.profiles?.email || p.user_id.slice(0, 8) + '...'}</td>
                <td>${capitalize(p.tier_name || '—')}</td>
                <td><strong>P${p.amount_pula}</strong></td>
                <td>${formatMethod(p.payment_method)}</td>
                <td>${statusBadge(p.status)}</td>
                <td>${formatDate(p.created_at)}</td>
                <td>
                    <div class="admin__actions">
                        <button class="admin__btn admin__btn--approve" onclick="adminApprove('${p.id}', '${p.user_id}', '${p.tier_name}')">
                            <i class="bi bi-check-lg"></i> Approve
                        </button>
                        <button class="admin__btn admin__btn--reject" onclick="adminReject('${p.id}')">
                            <i class="bi bi-x-lg"></i> Reject
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function renderRecentTable(transactions) {
        const tbody = document.getElementById('recentTableBody');
        if (!transactions.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="admin__no-data">No transactions yet</td></tr>';
            return;
        }
        tbody.innerHTML = transactions.slice(0, 20).map(t => `
            <tr>
                <td><code style="font-size:0.8rem;">${t.transaction_reference || '—'}</code></td>
                <td>${capitalize(t.tier_name || '—')}</td>
                <td><strong>P${t.amount_pula}</strong></td>
                <td>${formatMethod(t.payment_method)}</td>
                <td>${statusBadge(t.status)}</td>
                <td>${formatDate(t.created_at)}</td>
            </tr>
        `).join('');
    }

    async function adminApprove(txnId, userId, tierName) {
        if (!confirm('Approve this payment and activate the subscription?')) return;
        try {
            // Update transaction status
            const { error: txnErr } = await supabase
                .from('transactions')
                .update({
                    status: 'completed',
                    completed_at: new Date().toISOString(),
                    admin_notes: 'Approved via dashboard',
                })
                .eq('id', txnId);
            if (txnErr) throw txnErr;

            // Upgrade user's profile tier
            const config = TIER_CONFIG[tierName] || TIER_CONFIG.free;
            const { error: profErr } = await supabase
                .from('profiles')
                .update({
                    current_tier: tierName,
                    listing_limit: config.limit,
                })
                .eq('id', userId);
            if (profErr) throw profErr;

            alert('Payment approved and subscription activated!');
            await loadAdminData();

            // Refresh own profile if it was our own payment
            if (userId === currentUser.id) await loadProfile();
            updateTierDisplay();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function adminReject(txnId) {
        const reason = prompt('Rejection reason (optional):');
        if (reason === null) return;
        try {
            const { error } = await supabase
                .from('transactions')
                .update({
                    status: 'failed',
                    admin_notes: reason || 'Rejected via dashboard',
                })
                .eq('id', txnId);
            if (error) throw error;
            alert('Payment rejected.');
            await loadAdminData();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }


    /* ===========================================
       ADMIN — SALE TRANSACTIONS
       =========================================== */
    async function loadAdminSaleTransactions() {
        if (!isAdmin) return;

        try {
            const { data: sales, error } = await supabase
                .from('sale_transactions')
                .select('*, listings(make, model, year), buyer:profiles!sale_transactions_buyer_id_fkey(full_name, email), seller:profiles!sale_transactions_seller_id_fkey(full_name, email)')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) throw error;

            const txns = sales || [];
            const pending = txns.filter(t => t.status === 'PAID' || t.status === 'PENDING_RELEASE').length;
            const released = txns.filter(t => t.status === 'RELEASED').length;
            const totalCommission = txns.filter(t => t.status === 'RELEASED').reduce((s, t) => s + Number(t.commission_amount || 0), 0);
            const totalGMV = txns.filter(t => t.status === 'RELEASED').reduce((s, t) => s + Number(t.gross_amount || 0), 0);

            document.getElementById('statSalePending').textContent = pending;
            document.getElementById('statSaleReleased').textContent = released;
            document.getElementById('statCommission').textContent = formatPrice(totalCommission);
            document.getElementById('statGMV').textContent = formatPrice(totalGMV);

            const tbody = document.getElementById('saleTransTableBody');
            if (!txns.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="admin__no-data">No car sales yet</td></tr>';
                return;
            }

            tbody.innerHTML = txns.map(t => {
                const car = t.listings ? `${t.listings.make} ${t.listings.model} ${t.listings.year || ''}` : '—';
                const buyer = t.buyer ? (t.buyer.full_name || t.buyer.email || '—') : '—';
                const sColor = {
                    INITIATED: '#6b7280', PAID: '#3b82f6', PENDING_RELEASE: '#f59e0b',
                    RELEASED: '#16a34a', DISPUTED: '#ef4444', REFUNDED: '#8b5cf6', CANCELLED: '#6b7280'
                }[t.status] || '#6b7280';

                let actions = '';
                if (t.status === 'PAID') {
                    actions = `<button class="admin__btn admin__btn--approve" onclick="adminConfirmSale('${t.id}')"><i class="bi bi-check-lg"></i> Confirm</button>`;
                } else if (t.status === 'PENDING_RELEASE') {
                    actions = `<button class="admin__btn admin__btn--approve" onclick="adminReleaseSale('${t.id}')"><i class="bi bi-send"></i> Release</button>`;
                } else if (t.status === 'RELEASED') {
                    actions = '<span style="color:#16a34a;font-size:0.78rem;">Complete</span>';
                }
                if (t.status !== 'RELEASED' && t.status !== 'CANCELLED' && t.status !== 'REFUNDED') {
                    actions += ` <button class="admin__btn admin__btn--reject" onclick="adminDisputeSale('${t.id}')"><i class="bi bi-flag"></i></button>`;
                }

                return `<tr>
                    <td><code style="font-size:0.75rem;">${t.transaction_ref}</code></td>
                    <td>${car}</td>
                    <td style="font-size:0.82rem;">${buyer}</td>
                    <td><strong>${formatPrice(Number(t.gross_amount))}</strong></td>
                    <td style="color:#ef4444;">${formatPrice(Number(t.commission_amount))}</td>
                    <td>${formatPrice(Number(t.seller_net_amount))}</td>
                    <td><span style="color:${sColor};font-weight:600;font-size:0.8rem;">${t.status}</span></td>
                    <td style="font-size:0.78rem;">${formatDate(t.created_at)}</td>
                    <td><div class="admin__actions">${actions}</div></td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('Admin sale transactions error:', err);
        }
    }

    async function adminConfirmSale(txnId) {
        if (!confirm('Confirm this payment has been received?')) return;
        try {
            const { data: txn } = await supabase.from('sale_transactions').select('buyer_id, seller_id, listings(make, model)').eq('id', txnId).single();
            const { error } = await supabase
                .from('sale_transactions')
                .update({ status: 'PENDING_RELEASE', updated_at: new Date().toISOString() })
                .eq('id', txnId);
            if (error) throw error;

            // Notify both parties
            if (txn) {
                const car = txn.listings ? `${txn.listings.make} ${txn.listings.model}` : 'vehicle';
                await createNotification(txn.buyer_id, 'sale', 'Payment Confirmed', `Your payment for the ${car} has been verified. Processing seller payout.`, txnId);
                await createNotification(txn.seller_id, 'sale', 'Sale Confirmed', `Payment for your ${car} has been verified. Payout is being processed.`, txnId);
            }

            showToast('success', 'Payment Confirmed', 'Ready for release.');
            loadAdminSaleTransactions();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function adminReleaseSale(txnId) {
        if (!confirm('Release funds to seller? This will deduct commission and mark the sale as complete.')) return;
        try {
            const { data: txn } = await supabase.from('sale_transactions').select('buyer_id, seller_id, seller_net_amount, listings(make, model)').eq('id', txnId).single();
            const { error } = await supabase.rpc('release_funds', { txn_id: txnId });
            if (error) throw error;

            // Notify both parties
            if (txn) {
                const car = txn.listings ? `${txn.listings.make} ${txn.listings.model}` : 'vehicle';
                await createNotification(txn.buyer_id, 'sale', 'Purchase Complete', `Your purchase of the ${car} is complete. You can view your receipt in the dashboard.`, txnId);
                await createNotification(txn.seller_id, 'sale', 'Payout Sent', `${formatPrice(Number(txn.seller_net_amount))} has been released for your ${car}. View your receipt in Seller Dashboard.`, txnId);
            }

            showToast('success', 'Funds Released', 'Commission collected. Seller has been paid.');
            loadAdminSaleTransactions();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function adminDisputeSale(txnId) {
        const reason = prompt('Dispute reason:');
        if (!reason) return;
        try {
            const { error } = await supabase
                .from('sale_transactions')
                .update({ status: 'DISPUTED', disputed_at: new Date().toISOString(), notes: reason, updated_at: new Date().toISOString() })
                .eq('id', txnId);
            if (error) throw error;
            alert('Transaction marked as disputed.');
            loadAdminSaleTransactions();
        } catch (err) { alert('Error: ' + err.message); }
    }


    /* ===========================================
       ADMIN — SOURCING REQUESTS
       =========================================== */
    async function loadAdminSourcingRequests() {
        if (!isAdmin) return;
        try {
            const { data: reqs, error } = await supabase
                .from('sourcing_requests')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) throw error;

            const tbody = document.getElementById('sourcingTableBody');
            if (!reqs || !reqs.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="admin__no-data">No sourcing requests</td></tr>';
                return;
            }

            tbody.innerHTML = reqs.map(r => {
                const sColor = { new: '#3b82f6', reviewing: '#f59e0b', sourced: '#16a34a', closed: '#6b7280' }[r.status] || '#6b7280';
                return `<tr>
                    <td style="font-weight:600;">${r.contact_name}</td>
                    <td>${r.brand}</td>
                    <td>${r.model || '—'}</td>
                    <td>${r.year_range || '—'}</td>
                    <td>${r.budget ? 'P' + r.budget : '—'}</td>
                    <td style="font-size:0.78rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.notes || '—'}</td>
                    <td><span style="color:${sColor};font-weight:600;text-transform:capitalize;font-size:0.8rem;">${r.status}</span></td>
                    <td style="font-size:0.78rem;">${formatDate(r.created_at)}</td>
                    <td>
                        <select style="font-size:0.75rem;padding:4px;border-radius:4px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);" onchange="updateSourcingStatus('${r.id}', this.value)">
                            <option value="new" ${r.status==='new'?'selected':''}>New</option>
                            <option value="reviewing" ${r.status==='reviewing'?'selected':''}>Reviewing</option>
                            <option value="sourced" ${r.status==='sourced'?'selected':''}>Sourced</option>
                            <option value="closed" ${r.status==='closed'?'selected':''}>Closed</option>
                        </select>
                    </td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('Admin sourcing error:', err);
        }
    }

    async function updateSourcingStatus(reqId, newStatus) {
        try {
            await supabase
                .from('sourcing_requests')
                .update({ status: newStatus })
                .eq('id', reqId);
        } catch (err) {
            alert('Error updating: ' + err.message);
        }
    }


    /* ===========================================
       TOAST NOTIFICATION SYSTEM
       =========================================== */
    function showToast(type, title, msg, duration = 5000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const icons = {
            success: 'bi-check-circle-fill',
            info: 'bi-info-circle-fill',
            warning: 'bi-exclamation-triangle-fill',
            error: 'bi-x-circle-fill'
        };

        const toast = document.createElement('div');
        toast.className = `toast toast--${type}`;
        toast.innerHTML = `
            <i class="toast__icon bi ${icons[type] || icons.info}"></i>
            <div class="toast__body">
                <div class="toast__title">${title}</div>
                <div class="toast__msg">${msg}</div>
            </div>
            <span class="toast__close" onclick="dismissToast(this.parentElement)">&times;</span>
        `;
        container.appendChild(toast);

        const timer = setTimeout(() => dismissToast(toast), duration);
        toast.addEventListener('click', () => { clearTimeout(timer); dismissToast(toast); });
    }

    function dismissToast(el) {
        if (!el || el.classList.contains('toast--exit')) return;
        el.classList.add('toast--exit');
        setTimeout(() => el.remove(), 300);
    }


    /* ===========================================
       IN-APP NOTIFICATIONS TABLE + BELL
       =========================================== */
    async function createNotification(userId, type, title, body, relatedId) {
        try {
            await supabase.from('notifications').insert({
                user_id: userId,
                type: type,
                title: title,
                body: body,
                related_id: relatedId || null
            });
        } catch (err) { console.error('Notification insert error:', err); }
    }

    async function loadNotifications() {
        if (!currentUser) return [];
        try {
            const { data } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(20);
            return data || [];
        } catch (err) { return []; }
    }

    async function markNotificationsRead() {
        if (!currentUser) return;
        try {
            await supabase
                .from('notifications')
                .update({ read: true })
                .eq('user_id', currentUser.id)
                .eq('read', false);
        } catch (err) { /* silent */ }
    }

    async function updateNotifBadge() {
        if (!currentUser) return;
        try {
            const { count } = await supabase
                .from('notifications')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id)
                .eq('read', false);
            const badge = document.getElementById('navNotifBadge');
            if (badge) {
                if (count && count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch (err) { /* silent */ }
    }

    function showNotifPanel() {
        const panel = document.getElementById('notifPanel');
        if (!panel) return;
        const isOpen = panel.style.display === 'block';
        panel.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
            renderNotifPanel();
            markNotificationsRead();
            setTimeout(updateNotifBadge, 1000);
        }
    }

    async function renderNotifPanel() {
        const panel = document.getElementById('notifPanel');
        if (!panel) return;
        const notifs = await loadNotifications();
        if (!notifs.length) {
            panel.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);font-size:0.85rem;">No notifications yet</div>';
            return;
        }
        panel.innerHTML = notifs.map(n => {
            const icons = { sale: 'bi-bag-check', message: 'bi-chat-dots', dispute: 'bi-flag', system: 'bi-bell' };
            const icon = icons[n.type] || 'bi-bell';
            return `<div style="padding:12px 16px;border-bottom:1px solid var(--border-default);${n.read?'':'background:var(--bg-secondary);'}">
                <div style="display:flex;gap:8px;align-items:flex-start;">
                    <i class="bi ${icon}" style="color:var(--accent);margin-top:2px;"></i>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:${n.read?'400':'600'};font-size:0.85rem;">${n.title}</div>
                        <div style="font-size:0.78rem;color:var(--text-tertiary);margin-top:2px;">${n.body || ''}</div>
                        <div style="font-size:0.7rem;color:var(--text-tertiary);margin-top:4px;">${timeAgo(new Date(n.created_at))}</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }


    /* ===========================================
       RECEIPT GENERATION
       =========================================== */
    async function showReceipt(txnId) {
        try {
            const { data: txn, error } = await supabase
                .from('sale_transactions')
                .select('*, listings(make, model, year, location), buyer:profiles!sale_transactions_buyer_id_fkey(full_name, email), seller:profiles!sale_transactions_seller_id_fkey(full_name, email)')
                .eq('id', txnId)
                .single();

            if (error || !txn) throw error || new Error('Transaction not found');

            const car = txn.listings ? `${txn.listings.make} ${txn.listings.model} ${txn.listings.year || ''}` : 'Vehicle';
            const buyerName = txn.buyer ? (txn.buyer.full_name || txn.buyer.email) : '—';
            const sellerName = txn.seller ? (txn.seller.full_name || txn.seller.email) : '—';
            const location = txn.listings?.location || 'Botswana';
            const date = new Date(txn.created_at).toLocaleDateString('en-BW', { day: 'numeric', month: 'long', year: 'numeric' });
            const time = new Date(txn.created_at).toLocaleTimeString('en-BW', { hour: '2-digit', minute: '2-digit' });

            const card = document.getElementById('receiptCard');
            card.innerHTML = `
                <div class="receipt-card__header">
                    <div class="receipt-card__logo">PrimeDrive<span></span></div>
                    <div class="receipt-card__subtitle">Transaction Receipt</div>
                </div>
                <div class="receipt-card__body">
                    <div class="receipt-card__section-title">Transaction</div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Reference</span>
                        <span style="font-weight:700;font-family:monospace;">${txn.transaction_ref}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Date</span>
                        <span>${date} at ${time}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Status</span>
                        <span style="font-weight:600;color:${txn.status==='RELEASED'?'#16a34a':'#f59e0b'};">${txn.status === 'RELEASED' ? 'Completed' : txn.status}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Payment Method</span>
                        <span>${formatMethod(txn.payment_method)}</span>
                    </div>

                    <hr class="receipt-card__divider">
                    <div class="receipt-card__section-title">Vehicle</div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Vehicle</span>
                        <span style="font-weight:600;">${car}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Location</span>
                        <span>${location}</span>
                    </div>

                    <hr class="receipt-card__divider">
                    <div class="receipt-card__section-title">Parties</div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Buyer</span>
                        <span>${buyerName}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Seller</span>
                        <span>${sellerName}</span>
                    </div>

                    <hr class="receipt-card__divider">
                    <div class="receipt-card__section-title">Breakdown</div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Sale Price</span>
                        <span>${formatPrice(Number(txn.gross_amount))}</span>
                    </div>
                    <div class="receipt-card__row">
                        <span class="receipt-card__row--label">Platform Commission (${(Number(txn.commission_rate) * 100).toFixed(1)}%)</span>
                        <span style="color:#ef4444;">-${formatPrice(Number(txn.commission_amount))}</span>
                    </div>
                    <div class="receipt-card__row receipt-card__row--total">
                        <span>Seller Receives</span>
                        <span>${formatPrice(Number(txn.seller_net_amount))}</span>
                    </div>
                </div>
                <div class="receipt-card__actions">
                    <button class="receipt-card__btn-print" onclick="window.print()"><i class="bi bi-printer"></i> Print</button>
                    <button class="receipt-card__btn-close" onclick="closeReceipt()">Close</button>
                </div>
                <div class="receipt-card__footer">
                    PrimeDrive Botswana &middot; Receipt generated ${new Date().toLocaleDateString('en-BW')}<br>
                    This is a digital receipt for your records.
                </div>
            `;

            document.getElementById('receiptOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';

        } catch (err) {
            console.error('Receipt error:', err);
            showToast('error', 'Receipt Error', 'Could not generate receipt.');
        }
    }

    function closeReceipt() {
        document.getElementById('receiptOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }


    /* ===========================================
       DISPUTE FLOW
       =========================================== */
    async function openDispute(txnId) {
        if (!currentUser) return;

        const reason = prompt('Please describe the issue with this transaction:');
        if (!reason || !reason.trim()) return;

        try {
            // Create dispute record
            const { error: dErr } = await supabase.from('disputes').insert({
                transaction_id: txnId,
                filed_by: currentUser.id,
                reason: reason.trim(),
                status: 'open'
            });
            if (dErr) throw dErr;

            // Update transaction status
            await supabase
                .from('sale_transactions')
                .update({ status: 'DISPUTED', disputed_at: new Date().toISOString(), notes: reason.trim(), updated_at: new Date().toISOString() })
                .eq('id', txnId);

            // Notify admin
            const { data: admins } = await supabase.from('profiles').select('id').eq('is_admin', true);
            for (const admin of (admins || [])) {
                await createNotification(admin.id, 'dispute', 'New Dispute Filed', `A dispute has been filed for transaction. Reason: ${reason.trim().slice(0, 80)}`, txnId);
            }

            showToast('warning', 'Dispute Filed', 'Your dispute has been submitted. Our team will review it within 24-48 hours.');
            // Refresh relevant views
            loadBuyerPurchases();
            loadSellerEarnings();

        } catch (err) {
            console.error('Dispute error:', err);
            showToast('error', 'Error', 'Could not file dispute. Please try again.');
        }
    }

    async function adminResolveDispute(disputeId, txnId, resolution) {
        if (!isAdmin) return;
        const note = prompt(`Resolution note (${resolution}):`);
        if (note === null) return;

        try {
            await supabase.from('disputes').update({
                status: 'resolved',
                resolution: resolution,
                resolved_by: currentUser.id,
                resolution_notes: note,
                resolved_at: new Date().toISOString()
            }).eq('id', disputeId);

            // Update transaction based on resolution
            if (resolution === 'release') {
                await supabase.rpc('release_funds', { txn_id: txnId });
                showToast('success', 'Dispute Resolved', 'Funds released to seller.');
            } else if (resolution === 'refund') {
                await supabase.from('sale_transactions').update({
                    status: 'REFUNDED', refunded_at: new Date().toISOString(), updated_at: new Date().toISOString()
                }).eq('id', txnId);
                showToast('success', 'Dispute Resolved', 'Transaction marked for refund.');
            }

            loadAdminSaleTransactions();
            loadAdminDisputes();

        } catch (err) {
            console.error('Resolve dispute error:', err);
            showToast('error', 'Error', 'Could not resolve dispute.');
        }
    }

    async function loadAdminDisputes() {
        if (!isAdmin) return;
        try {
            const { data: disputes, error } = await supabase
                .from('disputes')
                .select('*, sale_transactions(transaction_ref, gross_amount, listings(make, model)), filer:profiles!disputes_filed_by_fkey(full_name, email)')
                .order('created_at', { ascending: false })
                .limit(30);

            if (error) throw error;

            const tbody = document.getElementById('disputesTableBody');
            if (!tbody) return;
            if (!disputes || !disputes.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="admin__no-data">No disputes</td></tr>';
                return;
            }

            tbody.innerHTML = disputes.map(d => {
                const txn = d.sale_transactions;
                const car = txn?.listings ? `${txn.listings.make} ${txn.listings.model}` : '—';
                const ref = txn?.transaction_ref || '—';
                const filer = d.filer ? (d.filer.full_name || d.filer.email) : '—';
                const sColor = { open: '#dc2626', reviewing: '#d97706', resolved: '#16a34a' }[d.status] || '#6b7280';

                let actions = '';
                if (d.status === 'open' || d.status === 'reviewing') {
                    actions = `
                        <button class="admin__btn admin__btn--approve" onclick="adminResolveDispute('${d.id}','${d.transaction_id}','release')"><i class="bi bi-check-lg"></i> Release</button>
                        <button class="admin__btn admin__btn--reject" onclick="adminResolveDispute('${d.id}','${d.transaction_id}','refund')"><i class="bi bi-arrow-counterclockwise"></i> Refund</button>`;
                } else {
                    actions = `<span style="font-size:0.78rem;color:#16a34a;">${d.resolution || 'Resolved'}</span>`;
                }

                return `<tr>
                    <td><code style="font-size:0.75rem;">${ref}</code></td>
                    <td>${car}</td>
                    <td style="font-size:0.82rem;">${filer}</td>
                    <td style="font-size:0.82rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.reason}</td>
                    <td><span class="dispute-badge dispute-badge--${d.status}">${d.status}</span></td>
                    <td style="font-size:0.78rem;">${formatDate(d.created_at)}</td>
                    <td><div class="admin__actions">${actions}</div></td>
                </tr>`;
            }).join('');

        } catch (err) {
            console.error('Admin disputes error:', err);
        }
    }


    /* ===========================================
       FORMATTING HELPERS
       =========================================== */
    function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

    function formatMethod(m) {
        const methods = { orange_money: 'Orange Money', myzaka: 'MyZaka', manual: 'Manual', bank_transfer: 'Bank Transfer', card: 'Card' };
        return methods[m] || m;
    }

    function formatDate(iso) {
        if (!iso) return '—';
        return new Date(iso).toLocaleDateString('en-BW', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function statusBadge(s) {
        const map = {
            pending: 'pending',
            awaiting_verification: 'awaiting',
            completed: 'completed',
            failed: 'failed',
            refunded: 'failed',
        };
        const cls = map[s] || 'pending';
        const label = s === 'awaiting_verification' ? 'Awaiting' : capitalize(s);
        return `<span class="admin__badge admin__badge--${cls}">${label}</span>`;
    }


    /* ===========================================
       PLAN TAB SWITCHING & FAQ
       =========================================== */
    function switchPlanTab(tab) {
        document.getElementById('tabIndividual').classList.toggle('active', tab === 'individual');
        document.getElementById('tabDealer').classList.toggle('active', tab === 'dealer');
        document.getElementById('panelIndividual').classList.toggle('active', tab === 'individual');
        document.getElementById('panelDealer').classList.toggle('active', tab === 'dealer');
        requestAnimationFrame(initRevealObserver);
    }

    function toggleFaq(el) {
        const wasOpen = el.classList.contains('open');
        // Close all
        document.querySelectorAll('.faq-item').forEach(item => item.classList.remove('open'));
        // Toggle clicked
        if (!wasOpen) el.classList.add('open');
    }


    /* ===========================================
       INIT
       =========================================== */
    document.addEventListener('DOMContentLoaded', () => {
        loadTheme();
        populateBuyFilters();
        populateRentFilters();
        loadFeaturedListings();
        loadMarketplaceListings();
        renderRentCars(rentalListings);
        initRevealObserver();

        // Handle deep link from PWA shortcuts
        handleHashNavigation();

        // Close login on overlay click
        document.getElementById('loginOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) hideLogin();
        });

        // Close login on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { hideLogin(); closeReceipt(); }
        });

        // Close notif panel on click outside
        document.addEventListener('click', (e) => {
            const wrap = document.getElementById('navNotifWrap');
            const panel = document.getElementById('notifPanel');
            if (panel && panel.style.display === 'block' && wrap && !wrap.contains(e.target)) {
                panel.style.display = 'none';
            }
        });

        // Poll for unread messages and notifications every 30 seconds
        setInterval(() => {
            if (currentUser) {
                updateUnreadBadge();
                updateNotifBadge();
            }
        }, 30000);
    });
    /* ===========================================
       PWA — SERVICE WORKER & INSTALL PROMPT
       =========================================== */
    let deferredInstallPrompt = null;

    // Register service worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                console.log('[PWA] Service worker registered:', reg.scope);

                // Listen for updates
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                            // New version available — could show update banner
                            console.log('[PWA] New version available');
                        }
                    });
                });
            } catch (err) {
                console.log('[PWA] SW registration failed:', err);
            }
        });
    }

    // Capture the install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;

        // Don't show if user dismissed recently
        const dismissed = localStorage.getItem('pd-pwa-dismissed');
        if (dismissed) {
            const dismissedTime = parseInt(dismissed);
            const daysSince = (Date.now() - dismissedTime) / (1000 * 60 * 60 * 24);
            if (daysSince < 3) return; // Wait 3 days before showing again
        }

        // Show install banner after a short delay
        setTimeout(() => {
            document.getElementById('pwaInstallBanner').classList.add('show');
        }, 2000);
    });

    async function installPWA() {
        if (!deferredInstallPrompt) return;
        deferredInstallPrompt.prompt();
        const result = await deferredInstallPrompt.userChoice;
        console.log('[PWA] Install result:', result.outcome);

        if (result.outcome === 'accepted') {
            document.getElementById('pwaInstallBanner').classList.remove('show');
        }
        deferredInstallPrompt = null;
    }

    function dismissInstallBanner() {
        document.getElementById('pwaInstallBanner').classList.remove('show');
        localStorage.setItem('pd-pwa-dismissed', Date.now().toString());
    }

    // Detect if already installed
    window.addEventListener('appinstalled', () => {
        document.getElementById('pwaInstallBanner').classList.remove('show');
        deferredInstallPrompt = null;
        console.log('[PWA] App installed successfully');
    });

    // iOS install hint (iOS doesn't fire beforeinstallprompt)
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    function isInStandaloneMode() {
        return window.matchMedia('(display-mode: standalone)').matches ||
               window.navigator.standalone === true;
    }
    if (isIOS() && !isInStandaloneMode()) {
        // Show a custom iOS install hint after delay
        setTimeout(() => {
            const banner = document.getElementById('pwaInstallBanner');
            const btn = document.getElementById('pwaInstallBtn');
            banner.querySelector('.pwa-install-banner__desc').textContent =
                'Tap the share button, then "Add to Home Screen"';
            btn.innerHTML = '<i class="bi bi-box-arrow-up"></i> How to Install';
            btn.onclick = () => {
                alert('To install PrimeDrive on your iPhone:\n\n1. Tap the Share button (box with arrow) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add"\n\nThat\'s it! PrimeDrive will appear on your home screen like a real app.');
            };

            const dismissed = localStorage.getItem('pd-pwa-dismissed');
            if (!dismissed || (Date.now() - parseInt(dismissed)) > 3 * 24 * 60 * 60 * 1000) {
                banner.classList.add('show');
            }
        }, 3000);
    }


    /* ===========================================
   NAVIGATION — HASH-BASED DEEP LINKING
   =========================================== */
function handleHashNavigation() {
    const hash = window.location.hash.replace('#', '');
    if (hash && document.getElementById('page-' + hash)) {
        navigate(hash);
    }
}

window.addEventListener('hashchange', handleHashNavigation);
window.addEventListener('load', handleHashNavigation);

    </script>
</body>
</html>
